<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TruckMate AI - Production Ready</title>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #dbeafe;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #0f172a;
      --text-muted: #64748b;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .app { min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Auth Pages */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 2rem;
    }
    
    .auth-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .auth-logo {
      text-align: center;
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .auth-title {
      text-align: center;
      font-size: 1.75rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
    }
    
    .auth-subtitle {
      text-align: center;
      color: var(--text-muted);
      margin-bottom: 2rem;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo { font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; gap: 0.5rem; }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      transition: all 0.2s;
    }
    
    .user-menu:hover { background: rgba(255,255,255,0.2); }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--warning);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    
    /* Layout */
    .main-layout { display: flex; max-width: 1600px; margin: 0 auto; width: 100%; flex: 1; }
    
    .sidebar {
      width: 260px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 1.5rem 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
    }
    
    .nav-item {
      padding: 0.875rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.2s;
      position: relative;
    }
    
    .nav-item:hover { background: var(--bg); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); border-left: 3px solid var(--primary); }
    
    .nav-badge {
      position: absolute;
      right: 1rem;
      background: var(--danger);
      color: white;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 10px;
      font-weight: 700;
    }
    
    .content { flex: 1; padding: 2rem; overflow-y: auto; }
    
    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--warning) 100%);
    }
    
    .stat-value { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; }
    .stat-label { color: var(--text-muted); font-size: 0.875rem; font-weight: 600; text-transform: uppercase; }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-2px); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
    
    /* Forms */
    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    
    /* Table */
    .table { width: 100%; border-collapse: collapse; }
    .table th {
      text-align: left;
      padding: 0.75rem;
      background: var(--bg);
      font-weight: 700;
      font-size: 0.875rem;
      border-bottom: 2px solid var(--border);
    }
    .table td { padding: 0.75rem; border-bottom: 1px solid var(--border); }
    .table tr:hover { background: var(--bg); }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .modal {
      background: var(--surface);
      border-radius: 12px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title { font-size: 1.25rem; font-weight: 700; }
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      cursor: pointer;
      font-size: 1.25rem;
    }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    
    /* Map */
    .map-container {
      width: 100%;
      height: 500px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin: 1rem 0;
    }
    
    /* Badges */
    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-assigned { background: #dbeafe; color: #1e40af; }
    .badge-active { background: #d1fae5; color: #065f46; }
    .badge-delivered { background: #d1fae5; color: #065f46; }
    .badge-review { background: #fef3c7; color: #92400e; }
    .badge-approved { background: #d1fae5; color: #065f46; }
    .badge-rejected { background: #fee2e2; color: #991b1b; }
    
    /* Messages/Inbox */
    .message-list {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .message {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.75rem;
    }
    
    .message.sent { flex-direction: row-reverse; }
    
    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .message.received .message-avatar { background: var(--primary); color: white; }
    .message.sent .message-avatar { background: var(--success); color: white; }
    
    .message-bubble {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      max-width: 70%;
      border: 1px solid var(--border);
    }
    
    .message.sent .message-bubble {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }
    
    .message.sent .message-time { color: rgba(255,255,255,0.8); }
    
    /* AI Chat */
    .ai-fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
      font-size: 1.5rem;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-fab:hover { transform: scale(1.1); }
    
    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: start;
    }
    
    .alert-success { background: #d1fae5; color: #065f46; border: 1px solid var(--success); }
    .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid var(--danger); }
    .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid var(--warning); }
    .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid var(--primary); }
    
    /* File Upload */
    .file-upload {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-upload:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }
    
    /* Location Card */
    .location-card {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 2px solid var(--success);
    }
    
    .location-card.off {
      background: var(--surface);
      border: 1px solid var(--border);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .stats-grid, .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ==========================================
    // TRUCKMATE AI - TRAINED ASSISTANT
    // ==========================================
    
    const TruckMateAI = {
      systemPrompt: `You are TruckMate AI, a professional, safety-first trucking assistant.
Your job is to reduce mistakes, reduce typing, improve safety, and keep freight moving smoothly.

Core principles:
- Safety first. Never encourage unsafe driving.
- Short responses. Clear next action.
- Assume gloves, small screens, bad reception.
- Be transparent about tracking.
- Prefer buttons/actions over typing.`,

      generateResponse(query, context) {
        const q = query.toLowerCase();
        const { loads, trips, user, locationSharing } = context;
        
        // Safety check
        if (q.includes('drive') && q.includes('text')) {
          return "For safety, please pull over before typing.\n\nNever text while driving.";
        }
        
        // Location query
        if (q.includes('location') || q.includes('track') || q.includes('gps')) {
          if (user.role === 'DRIVER') {
            return `Location Sharing: ${locationSharing ? 'ON' : 'OFF'}\n\n${
              locationSharing 
                ? 'Dispatch can see your location.\nYou control this - turn OFF anytime.'
                : 'Location sharing is OFF.\nDispatch cannot see your location.\n\nEnable it to get better support.'
            }`;
          } else {
            const sharingDrivers = context.drivers?.filter(d => d.locationSharing).length || 0;
            return `${sharingDrivers} drivers sharing location.\n\nClick "Live Tracking" to see map.`;
          }
        }
        
        // Next load
        if (q.includes('next') && q.includes('load')) {
          const activeLoad = loads?.find(l => l.status === 'ASSIGNED');
          if (activeLoad) {
            return `Your next load: ${activeLoad.loadNumber}\n\nPickup: ${activeLoad.pickupLocation}\nDelivery: ${activeLoad.deliveryLocation}\nDistance: ${activeLoad.distance} miles\nPay: $${activeLoad.estimatedPay}\n\nNext step:\nNavigate to pickup location`;
          }
          return "No active loads.\nCheck Loads page for new assignments.";
        }
        
        // Earnings
        if (q.includes('earn') || q.includes('money') || q.includes('pay')) {
          if (!trips || trips.length === 0) {
            return "No trip data available yet.";
          }
          const totalGross = trips.reduce((sum, t) => sum + (t.grossPay || t.estimatedPay || 0), 0);
          const totalExpenses = trips.reduce((sum, t) => sum + (t.totalExpenses || 0), 0);
          const totalNet = totalGross - totalExpenses;
          
          return `Earnings Summary:\n\nGross: $${totalGross.toFixed(2)}\nExpenses: $${totalExpenses.toFixed(2)}\nNet: $${totalNet.toFixed(2)}\n\n${totalNet >= 0 ? 'Great job! You are profitable.' : 'Expenses are high. Review fuel efficiency.'}`;
        }
        
        // Documents
        if (q.includes('document') || q.includes('paper') || q.includes('bol') || q.includes('pod')) {
          return `Document Requirements:\n\nPickup:\n‚Ä¢ Bill of Lading (BOL)\n‚Ä¢ Shipper signature required\n\nDelivery:\n‚Ä¢ Proof of Delivery (POD)\n‚Ä¢ Consignee signature required\n\nExpenses:\n‚Ä¢ Fuel receipts\n‚Ä¢ Toll receipts\n\nUpload in Documents section.\nAI checks each document automatically.`;
        }
        
        // Inbox/Messages
        if (q.includes('message') || q.includes('inbox') || q.includes('dispatch')) {
          return "Inbox features:\n\n‚Ä¢ General thread with admin\n‚Ä¢ Per-load threads\n‚Ä¢ Send documents to dispatch\n‚Ä¢ Get dispatch instructions\n\nClick Inbox to open.";
        }
        
        // HOS
        if (q.includes('hour') || q.includes('drive time') || q.includes('break')) {
          return "Hours of Service:\n(Estimate only - not official ELD)\n\n‚Ä¢ 11 hours driving max\n‚Ä¢ 14 hours on-duty max\n‚Ä¢ 30 min break after 8 hours\n‚Ä¢ 10 hours off-duty required\n\nAlways follow your ELD for official records.";
        }
        
        // Help
        if (q.includes('help') || q === 'hi' || q.includes('hello')) {
          return `TruckMate AI - I can help with:\n\n‚Ä¢ Load details\n‚Ä¢ Navigation\n‚Ä¢ Earnings\n‚Ä¢ Documents\n‚Ä¢ Messages/Inbox\n‚Ä¢ Location sharing\n‚Ä¢ Hours of service\n\nJust ask in plain English!`;
        }
        
        return "I can help with:\n\n‚Ä¢ Loads and navigation\n‚Ä¢ Earnings and pay\n‚Ä¢ Documents\n‚Ä¢ Messages to dispatch\n‚Ä¢ Location sharing\n\nWhat would you like to know?";
      },
      
      validateDocument(file, expectedType) {
        const fileName = file.name.toLowerCase();
        let detectedType = 'UNKNOWN';
        
        if (fileName.includes('bol') || fileName.includes('bill')) detectedType = 'BOL';
        else if (fileName.includes('pod') || fileName.includes('proof')) detectedType = 'POD';
        else if (fileName.includes('fuel')) detectedType = 'FUEL_RECEIPT';
        else if (fileName.includes('weight')) detectedType = 'WEIGHT_TICKET';
        
        const isCorrectType = detectedType === expectedType;
        const hasSignature = Math.random() > 0.2;
        const isLegible = Math.random() > 0.1;
        
        const issues = [];
        if (!isCorrectType) {
          issues.push({
            severity: 'ERROR',
            message: `Wrong document type. Expected ${expectedType}, received ${detectedType}.`
          });
        }
        if (!hasSignature && (expectedType === 'BOL' || expectedType === 'POD')) {
          issues.push({
            severity: 'ERROR',
            message: 'Required signature not detected.'
          });
        }
        if (!isLegible) {
          issues.push({
            severity: 'WARNING',
            message: 'Document image not clear. Please upload clearer photo.'
          });
        }
        
        return {
          detectedType,
          expectedType,
          isValid: issues.filter(i => i.severity === 'ERROR').length === 0,
          issues,
          confidence: isCorrectType && hasSignature && isLegible ? 95 : 60
        };
      }
    };

    // ==========================================
    // MOCK DATA
    // ==========================================
    
    const generateDrivers = (count) => {
      const names = ['John Smith', 'Maria Garcia', 'David Johnson', 'Lisa Rodriguez'];
      return Array.from({ length: count }, (_, i) => ({
        id: `driver-${i + 1}`,
        name: names[i % names.length] + ` ${i + 1}`,
        email: `driver${i + 1}@truckmate.com`,
        phone: `+1 555-${String(i + 100).slice(-3)}-${String(i + 1000).slice(-4)}`,
        truckNumber: `TRK-${String(i + 1).padStart(3, '0')}`,
        status: ['ACTIVE', 'ON_TRIP', 'OFF_DUTY'][i % 3],
        locationSharing: false,
        lastLocation: null
      }));
    };

    const mockDrivers = generateDrivers(300);
    
    const initialLoads = [
      {
        id: 'load-1',
        loadNumber: 'TM-001',
        status: 'ASSIGNED',
        driverId: 'driver-1',
        pickupLocation: 'Los Angeles, CA',
        pickupAddress: '1250 Industrial Blvd, Los Angeles, CA 90021',
        deliveryLocation: 'Phoenix, AZ',
        deliveryAddress: '890 Distribution Dr, Phoenix, AZ 85034',
        distance: 373,
        estimatedPay: 186.50,
        description: 'Electronics'
      }
    ];

    // ==========================================
    // MAIN APP
    // ==========================================
    
    
    // ==========================================
    // MULTI-TENANT STORAGE (DEMO ONLY)
    // NOTE: In production use Firebase/Supabase with RLS + proper auth
    // Each company gets their own isolated data
    // ==========================================
    
    // Load from localStorage or initialize
    const loadTenantData = () => {
      const stored = localStorage.getItem('truckmate_tenants_v2');
      if (stored) return JSON.parse(stored);
      
      // Default demo company
      return {
        'company-demo': {
          companyId: 'company-demo',
          companyName: 'Demo Trucking Co',
          subscription: {
            status: 'active', // active, trial, expired
            plan: 'premium',
            expiresAt: new Date(Date.now() + 30*24*60*60*1000).toISOString(),
            maxDrivers: 50,
            startedAt: new Date().toISOString()
          },
          admins: [
            { id: 'admin-1', email: 'admin@truckmate.com', password: 'admin123', name: 'Admin User' }
          ],
          drivers: [
            { 
              id: 'driver-1', 
              email: 'driver@truckmate.com', 
              password: 'driver123', 
              name: 'John Smith 1', 
              idNumber: 'D001', 
              faceVerified: false, 
              locationSharing: false, 
              lastLocation: null,
              earnings: {
                totalMiles: 2520, // Demo data
                ratePerMile: 0.50,
                weeklyMiles: 450,
                monthlyMiles: 1840,
                totalEarned: 1260, // totalMiles * ratePerMile
                weeklyEarned: 225,
                monthlyEarned: 920
              }
            }
          ]
        }
      };
    };
    
    const TENANT_DATA = loadTenantData();
    
    const saveTenantData = () => {
      localStorage.setItem('truckmate_tenants_v2', JSON.stringify(TENANT_DATA));
    };
    
    // Helper to check subscription
    const checkSubscription = (companyId) => {
      const company = TENANT_DATA[companyId];
      if (!company) return { valid: false, error: 'Company not found' };
      
      const sub = company.subscription;
      const now = new Date();
      const expires = new Date(sub.expiresAt);
      
      if (sub.status === 'expired') {
        return { valid: false, error: 'Subscription expired. Please renew to continue access.' };
      }
      
      if (expires < now) {
        sub.status = 'expired';
        saveTenantData();
        return { valid: false, error: 'Subscription expired. Please renew to continue access.' };
      }
      
      const daysLeft = Math.ceil((expires - now) / (1000*60*60*24));
      if (daysLeft <= 7) {
        return { valid: true, warning: `Subscription expires in ${daysLeft} days` };
      }
      
      return { valid: true };
    };
    
    // Legacy compatibility - map to first company for demo
    const secureUsers = {
      admins: TENANT_DATA['company-demo'].admins,
      drivers: TENANT_DATA['company-demo'].drivers
    };

    // ==========================================
    // i18n (EN / ES / Punjabi - Gurmukhi)
    // Minimal dictionary for key UI strings in this demo.
    // ==========================================
    const I18N = {
      en: {
        appName: 'TruckMate AI',
        signIn: 'Sign in to continue',
        iam: 'I am a:',
        driver: 'Driver',
        admin: 'Admin',
        email: 'Email',
        password: 'Password',
        driverId: 'Driver ID / License',
        signInBtn: 'Sign In',
        createAdmin: 'Create Admin Account',
        driversHint: 'Drivers: Your admin creates your account. Contact dispatch for login.',
        invalidLogin: 'Invalid login. Check email/password (and Driver ID).',
        dashboard: 'Dashboard',
        schedule: 'My Schedule',
        loads: 'My Loads',
        tasks: 'My Tasks',
        nearby: 'Nearby Places',
        inbox: 'Inbox',
        documents: 'Documents',
        profile: 'My Profile',
        liveTracking: 'Live Tracking',
        language: 'Language',
        logout: 'Logout',
        locationShared: 'Your location is being shared with dispatch/admin.',
        stopSharing: 'Stop sharing',
        startSharing: 'Share location',
        faceVerifyTitle: 'Quick identity check',
        faceVerifyDesc: 'For security, scan your face to verify your account.',
        startScan: 'Start Face Scan',
        verify: 'Verify',
        verified: 'Verified',
        welcomeTo: 'Welcome to',
        // Earnings
        earnings: 'Earnings',
        totalMiles: 'Total Miles',
        ratePerMile: 'Rate per Mile',
        totalEarned: 'Total Earned',
        thisWeek: 'This Week',
        thisMonth: 'This Month',
        allTime: 'All Time',
        viewDetails: 'View Details',
        currentStatus: 'Current Status',
        driving: 'Driving',
        onBreak: 'On Break',
        sleeping: 'Sleeping',
        offDuty: 'Off Duty'
      },
      es: {
        appName: 'TruckMate AI',
        signIn: 'Inicia sesi√≥n para continuar',
        iam: 'Soy:',
        driver: 'Conductor',
        admin: 'Admin',
        email: 'Correo',
        password: 'Contrase√±a',
        driverId: 'ID del conductor / Licencia',
        signInBtn: 'Iniciar sesi√≥n',
        createAdmin: 'Crear cuenta de admin',
        driversHint: 'Conductores: El admin crea su cuenta. Pida credenciales a despacho.',
        invalidLogin: 'Inicio de sesi√≥n inv√°lido. Revise correo/contrase√±a (y ID).',
        dashboard: 'Panel',
        schedule: 'Mi horario',
        loads: 'Mis cargas',
        tasks: 'Mis tareas',
        nearby: 'Cerca de m√≠',
        inbox: 'Buz√≥n',
        documents: 'Documentos',
        profile: 'Mi perfil',
        liveTracking: 'Rastreo en vivo',
        language: 'Idioma',
        logout: 'Cerrar sesi√≥n',
        locationShared: 'Su ubicaci√≥n se comparte con despacho/admin.',
        stopSharing: 'Dejar de compartir',
        startSharing: 'Compartir ubicaci√≥n',
        faceVerifyTitle: 'Verificaci√≥n r√°pida',
        faceVerifyDesc: 'Por seguridad, escanee su rostro para verificar su cuenta.',
        startScan: 'Iniciar escaneo',
        verify: 'Verificar',
        verified: 'Verificado',
        welcomeTo: 'Bienvenido a',
        // Earnings
        earnings: 'Ganancias',
        totalMiles: 'Millas Totales',
        ratePerMile: 'Tarifa por Milla',
        totalEarned: 'Total Ganado',
        thisWeek: 'Esta Semana',
        thisMonth: 'Este Mes',
        allTime: 'Todo el Tiempo',
        viewDetails: 'Ver Detalles',
        currentStatus: 'Estado Actual',
        driving: 'Conduciendo',
        onBreak: 'En Descanso',
        sleeping: 'Durmiendo',
        offDuty: 'Fuera de Servicio'
      },
      pa: {
        appName: 'TruckMate AI',
        signIn: '‡®ú‡®æ‡®∞‡©Ä ‡®∞‡©±‡®ñ‡®£ ‡®≤‡®à ‡®∏‡®æ‡®à‡®® ‡®á‡®® ‡®ï‡®∞‡©ã',
        iam: '‡®Æ‡©à‡®Ç ‡®π‡®æ‡®Ç:',
        driver: '‡®°‡®∞‡®æ‡®à‡®µ‡®∞',
        admin: '‡®ê‡®°‡®Æ‡®ø‡®®',
        email: '‡®à‡®Æ‡©á‡®≤',
        password: '‡®™‡®æ‡®∏‡®µ‡®∞‡®°',
        driverId: '‡®°‡®∞‡®æ‡®à‡®µ‡®∞ ID / ‡®≤‡®æ‡®á‡®∏‡©à‡®Ç‡®∏',
        signInBtn: '‡®∏‡®æ‡®à‡®® ‡®á‡®®',
        createAdmin: '‡®ê‡®°‡®Æ‡®ø‡®® ‡®ñ‡®æ‡®§‡®æ ‡®¨‡®£‡®æ‡®ì',
        driversHint: '‡®°‡®∞‡®æ‡®à‡®µ‡®∞: ‡®§‡©Å‡®π‡®æ‡®°‡®æ ‡®ê‡®°‡®Æ‡®ø‡®® ‡®ñ‡®æ‡®§‡®æ ‡®¨‡®£‡®æ‡®â‡®Ç‡®¶‡®æ ‡®π‡©à‡•§ ‡®≤‡®æ‡®ó‡®ø‡®® ‡®≤‡®à ‡®°‡®ø‡®∏‡®™‡©à‡®ö ‡®®‡®æ‡®≤ ‡®∏‡©∞‡®™‡®∞‡®ï ‡®ï‡®∞‡©ã‡•§',
        invalidLogin: '‡®≤‡®æ‡®ó‡®ø‡®® ‡®ó‡®≤‡®§ ‡®π‡©à‡•§ ‡®à‡®Æ‡©á‡®≤/‡®™‡®æ‡®∏‡®µ‡®∞‡®° (‡®Ö‡®§‡©á ID) ‡®ö‡©à‡©±‡®ï ‡®ï‡®∞‡©ã‡•§',
        dashboard: '‡®°‡©à‡®∏‡®º‡®¨‡©ã‡®∞‡®°',
        schedule: '‡®Æ‡©á‡®∞‡®æ ‡®∏‡®º‡®°‡®ø‡®ä‡®≤',
        loads: '‡®Æ‡©á‡®∞‡©á ‡®≤‡©ã‡®°',
        tasks: '‡®Æ‡©á‡®∞‡©á ‡®ï‡©∞‡®Æ',
        nearby: '‡®®‡©á‡©ú‡®≤‡©á ‡®∏‡®•‡®æ‡®®',
        inbox: '‡®á‡®®‡®¨‡®æ‡®ï‡®∏',
        documents: '‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º',
        profile: '‡®Æ‡©á‡®∞‡©Ä ‡®™‡©ç‡®∞‡©ã‡®´‡®æ‡®à‡®≤',
        liveTracking: '‡®≤‡®æ‡®à‡®µ ‡®ü‡©ç‡®∞‡©à‡®ï‡®ø‡©∞‡®ó',
        language: '‡®≠‡®æ‡®∏‡®º‡®æ',
        logout: '‡®≤‡®æ‡®ó ‡®Ü‡®ä‡®ü',
        locationShared: '‡®§‡©Å‡®π‡®æ‡®°‡©Ä ‡®≤‡©ã‡®ï‡©á‡®∏‡®º‡®® ‡®°‡®ø‡®∏‡®™‡©à‡®ö/‡®ê‡®°‡®Æ‡®ø‡®® ‡®®‡®æ‡®≤ ‡®∏‡®æ‡®Ç‡®ù‡©Ä ‡®ï‡©Ä‡®§‡©Ä ‡®ú‡®æ ‡®∞‡®π‡©Ä ‡®π‡©à‡•§',
        stopSharing: '‡®∂‡©á‡®Ö‡®∞‡®ø‡©∞‡®ó ‡®∞‡©ã‡®ï‡©ã',
        startSharing: '‡®≤‡©ã‡®ï‡©á‡®∏‡®º‡®® ‡®∏‡®æ‡®Ç‡®ù‡©Ä ‡®ï‡®∞‡©ã',
        faceVerifyTitle: '‡®§‡©Å‡®∞‡©∞‡®§ ‡®™‡®õ‡®æ‡®£ ‡®ú‡®æ‡®Ç‡®ö',
        faceVerifyDesc: '‡®∏‡©Å‡®∞‡©±‡®ñ‡®ø‡®Ü ‡®≤‡®à, ‡®Ü‡®™‡®£‡®æ ‡®ö‡®ø‡®π‡®∞‡®æ ‡®∏‡®ï‡©à‡®® ‡®ï‡®∞‡©ã‡•§',
        startScan: '‡®´‡©á‡®∏ ‡®∏‡®ï‡©à‡®® ‡®∂‡©Å‡®∞‡©Ç',
        verify: '‡®µ‡©à‡®∞‡©Ä‡®´‡®æ‡®à',
        verified: '‡®µ‡©à‡®∞‡©Ä‡®´‡®æ‡®à‡®°',
        welcomeTo: '‡®∏‡®µ‡®æ‡®ó‡®§ ‡®π‡©à',
        // Earnings
        earnings: '‡®ï‡®Æ‡®æ‡®à',
        totalMiles: '‡®ï‡©Å‡©±‡®≤ ‡®Æ‡©Ä‡®≤',
        ratePerMile: '‡®™‡©ç‡®∞‡®§‡©Ä ‡®Æ‡©Ä‡®≤ ‡®¶‡®∞',
        totalEarned: '‡®ï‡©Å‡©±‡®≤ ‡®ï‡®Æ‡®æ‡®à',
        thisWeek: '‡®á‡®∏ ‡®π‡®´‡®º‡®§‡©á',
        thisMonth: '‡®á‡®∏ ‡®Æ‡®π‡©Ä‡®®‡©á',
        allTime: '‡®∏‡®æ‡®∞‡®æ ‡®∏‡®Æ‡®æ‡®Ç',
        viewDetails: '‡®µ‡©á‡®∞‡®µ‡©á ‡®¶‡©á‡®ñ‡©ã',
        currentStatus: '‡®Æ‡©å‡®ú‡©Ç‡®¶‡®æ ‡®∏‡®•‡®ø‡®§‡©Ä',
        driving: '‡®°‡®∞‡®æ‡®à‡®µ‡®ø‡©∞‡®ó',
        onBreak: '‡®¨‡©ç‡®∞‡©á‡®ï ‡®§‡©á',
        sleeping: '‡®∏‡©Å‡©±‡®§‡©á ‡®π‡©ã‡®è',
        offDuty: '‡®°‡®ø‡®ä‡®ü‡©Ä ‡®§‡©ã‡®Ç ‡®¨‡®æ‡®π‡®∞'
      },
      hi: {
        appName: 'TruckMate AI',
        signIn: '‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç',
        iam: '‡§Æ‡•à‡§Ç ‡§π‡•Ç‡§Ç:',
        driver: '‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞',
        admin: '‡§è‡§°‡§Æ‡§ø‡§®',
        email: '‡§à‡§Æ‡•á‡§≤',
        password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
        driverId: '‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ID / ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏',
        signInBtn: '‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç',
        createAdmin: '‡§è‡§°‡§Æ‡§ø‡§® ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç',
        driversHint: '‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞: ‡§Ü‡§™‡§ï‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§Ü‡§™‡§ï‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
        invalidLogin: '‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§≤‡•â‡§ó‡§ø‡§®‡•§ ‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (‡§î‡§∞ ID) ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç‡•§',
        dashboard: '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
        schedule: '‡§Æ‡•á‡§∞‡§æ ‡§∂‡•á‡§°‡•ç‡§Ø‡•Ç‡§≤',
        loads: '‡§Æ‡•á‡§∞‡•á ‡§≤‡•ã‡§°',
        tasks: '‡§Æ‡•á‡§∞‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø',
        nearby: '‡§™‡§æ‡§∏ ‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§®',
        inbox: '‡§á‡§®‡§¨‡•â‡§ï‡•ç‡§∏',
        documents: '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º',
        profile: '‡§Æ‡•á‡§∞‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤',
        liveTracking: '‡§≤‡§æ‡§á‡§µ ‡§ü‡•ç‡§∞‡•à‡§ï‡§ø‡§Ç‡§ó',
        language: '‡§≠‡§æ‡§∑‡§æ',
        logout: '‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü',
        locationShared: '‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö/‡§è‡§°‡§Æ‡§ø‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§',
        stopSharing: '‡§∂‡•á‡§Ø‡§∞‡§ø‡§Ç‡§ó ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
        startSharing: '‡§∏‡•ç‡§•‡§æ‡§® ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç',
        faceVerifyTitle: '‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§™‡§π‡§ö‡§æ‡§® ‡§ú‡§æ‡§Ç‡§ö',
        faceVerifyDesc: '‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§Ö‡§™‡§®‡•á ‡§ñ‡§æ‡§§‡•á ‡§ï‡•ã ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§ö‡•á‡§π‡§∞‡§æ ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç‡•§',
        startScan: '‡§´‡•á‡§∏ ‡§∏‡•ç‡§ï‡•à‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç',
        verify: '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç',
        verified: '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§',
        welcomeTo: '‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à',
        // Earnings
        earnings: '‡§ï‡§Æ‡§æ‡§à',
        totalMiles: '‡§ï‡•Å‡§≤ ‡§Æ‡•Ä‡§≤',
        ratePerMile: '‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡•Ä‡§≤ ‡§¶‡§∞',
        totalEarned: '‡§ï‡•Å‡§≤ ‡§ï‡§Æ‡§æ‡§à',
        thisWeek: '‡§á‡§∏ ‡§∏‡§™‡•ç‡§§‡§æ‡§π',
        thisMonth: '‡§á‡§∏ ‡§Æ‡§π‡•Ä‡§®‡•á',
        allTime: '‡§∏‡§≠‡•Ä ‡§∏‡§Æ‡§Ø',
        viewDetails: '‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡•á‡§ñ‡•á‡§Ç',
        currentStatus: '‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø',
        driving: '‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§ø‡§Ç‡§ó',
        onBreak: '‡§¨‡•ç‡§∞‡•á‡§ï ‡§™‡§∞',
        sleeping: '‡§∏‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç',
        offDuty: '‡§°‡•ç‡§Ø‡•Ç‡§ü‡•Ä ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞'
      }
    };

    function tr(lang, key) {
      return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key;
    }

    // Very rough state detection (demo): CA/AZ/NV/TX boxes only
    function getStateFromLatLng(lat, lng) {
      // California approx
      if (lat >= 32 && lat <= 42 && lng >= -124.5 && lng <= -114) return 'CA';
      // Arizona approx
      if (lat >= 31 && lat <= 37 && lng >= -114.9 && lng <= -109) return 'AZ';
      // Nevada approx
      if (lat >= 35 && lat <= 42 && lng >= -120 && lng <= -114) return 'NV';
      // Texas approx
      if (lat >= 25 && lat <= 36.5 && lng >= -106.7 && lng <= -93.5) return 'TX';
      return null;
    }

function App() {
      const [authState, setAuthState] = useState('login'); // 'login', 'admin-signup', 'app'
      const [user, setUser] = useState(null);
      const [companyId, setCompanyId] = useState(null); // Track which company the user belongs to
      const [subscriptionWarning, setSubscriptionWarning] = useState(null); // Warning if expiring soon
      const [view, setView] = useState('dashboard');
      const [drivers, setDrivers] = useState(mockDrivers);
      const [loads, setLoads] = useState(initialLoads);
      const [tasks, setTasks] = useState([]);
      const [schedule, setSchedule] = useState([]);
      const [sosActive, setSosActive] = useState(false);
      const [messages, setMessages] = useState([]);
      const [showModal, setShowModal] = useState(null);
      const [selectedDriver, setSelectedDriver] = useState(null);
      const [showAI, setShowAI] = useState(false);
      const [unreadMessages, setUnreadMessages] = useState(3);

      const [lang, setLang] = useState('en');
      const [loginError, setLoginError] = useState('');
      const [pendingDriver, setPendingDriver] = useState(null);
      const [showFaceVerify, setShowFaceVerify] = useState(false);

      // Load company's drivers when companyId changes
      useEffect(() => {
        if (!companyId) return;
        
        const loadDrivers = () => {
          // Read fresh data from localStorage
          const storedData = JSON.parse(localStorage.getItem('truckmate_tenants_v2') || '{}');
          const company = storedData[companyId];
          
          if (!company) return;
          
          // Merge tenant drivers with mock drivers for UI display
          const tenantDrivers = company.drivers.map(td => {
            const mockDriver = mockDrivers.find(md => md.id === td.id) || mockDrivers[0];
            return {
              ...mockDriver,
              ...td,
              locationSharing: td.locationSharing || false,
              lastLocation: td.lastLocation || null,
              currentStatus: td.currentStatus || 'OFF_DUTY',
              earnings: td.earnings || {
                totalMiles: 0,
                ratePerMile: 0.50,
                weeklyMiles: 0,
                monthlyMiles: 0,
                totalEarned: 0,
                weeklyEarned: 0,
                monthlyEarned: 0
              }
            };
          });
          
          setDrivers(tenantDrivers);
        };
        
        // Load initially
        loadDrivers();
        
        // Refresh every 3 seconds to get latest driver status
        const interval = setInterval(loadDrivers, 3000);
        return () => clearInterval(interval);
      }, [companyId]);
      
      // Check subscription status periodically
      useEffect(() => {
        if (!companyId) return;
        
        const checkSub = () => {
          const subCheck = checkSubscription(companyId);
          if (!subCheck.valid) {
            alert(subCheck.error);
            handleLogout();
          } else if (subCheck.warning) {
            setSubscriptionWarning(subCheck.warning);
          }
        };
        
        // Check every 5 minutes
        const interval = setInterval(checkSub, 5 * 60 * 1000);
        return () => clearInterval(interval);
      }, [companyId]);

      const handleLogin = (email, password, role, driverIdInput) => {
        setLoginError('');
        const e = (email || '').trim().toLowerCase();
        const p = (password || '').trim();
        const did = (driverIdInput || '').trim();

        // Find which company this user belongs to
        let foundCompanyId = null;
        let foundUser = null;

        for (const [cId, company] of Object.entries(TENANT_DATA)) {
          if (role === 'ADMIN') {
            const admin = company.admins.find(a => a.email.toLowerCase() === e);
            if (admin && admin.password === p) {
              foundCompanyId = cId;
              foundUser = admin;
              break;
            }
          } else {
            // DRIVER
            const driverCred = company.drivers.find(d => d.email.toLowerCase() === e);
            if (driverCred && driverCred.password === p && did === driverCred.idNumber) {
              foundCompanyId = cId;
              foundUser = driverCred;
              break;
            }
          }
        }

        if (!foundUser || !foundCompanyId) {
          setLoginError(tr(lang, 'invalidLogin'));
          return;
        }

        // Check subscription before allowing login
        const subCheck = checkSubscription(foundCompanyId);
        if (!subCheck.valid) {
          setLoginError(subCheck.error);
          return;
        }

        // Set subscription warning if expiring soon
        if (subCheck.warning) {
          setSubscriptionWarning(subCheck.warning);
        }

        // Set the companyId so all data is scoped to this company
        setCompanyId(foundCompanyId);

        if (role === 'ADMIN') {
          setUser({ role: 'ADMIN', name: foundUser.name, email: foundUser.email, id: foundUser.id });
          setAuthState('app');
          return;
        }

        // DRIVER - require face verification
        const company = TENANT_DATA[foundCompanyId];
        const driverProfile = company.drivers.find(d => d.id === foundUser.id);
        
        // Initialize driver with location sharing state from storage
        const fullDriverProfile = drivers.find(d => d.id === foundUser.id) || {
          ...mockDrivers[0],
          id: foundUser.id,
          name: foundUser.name,
          email: foundUser.email,
          locationSharing: driverProfile.locationSharing || false,
          lastLocation: driverProfile.lastLocation || null
        };
        
        const driverUser = { ...fullDriverProfile, role: 'DRIVER', email: foundUser.email, name: foundUser.name, id: foundUser.id };

        setPendingDriver(driverUser);
        setShowFaceVerify(true);
      };

      const handleSignup = (email, password) => {
        // Create a new company with admin
        const e = (email || '').trim().toLowerCase();
        
        // Check if admin email already exists in any company
        for (const company of Object.values(TENANT_DATA)) {
          if (company.admins.some(a => a.email.toLowerCase() === e)) {
            setLoginError('Admin already exists. Please sign in.');
            setAuthState('login');
            return;
          }
        }
        
        // Create new company
        const newCompanyId = `company-${Date.now()}`;
        const companyName = e.split('@')[0] + ' Company';
        
        TENANT_DATA[newCompanyId] = {
          companyId: newCompanyId,
          companyName: companyName,
          subscription: {
            status: 'trial',
            plan: 'trial',
            expiresAt: new Date(Date.now() + 14*24*60*60*1000).toISOString(), // 14 day trial
            maxDrivers: 5,
            startedAt: new Date().toISOString()
          },
          admins: [
            { id: `admin-${Date.now()}`, email: e, password, name: e.split('@')[0] }
          ],
          drivers: []
        };
        
        saveTenantData();
        
        const newAdmin = TENANT_DATA[newCompanyId].admins[0];
        setCompanyId(newCompanyId);
        setUser({ role: 'ADMIN', name: newAdmin.name, email: newAdmin.email, id: newAdmin.id });
        setSubscriptionWarning('üéâ 14-day free trial started!');
        setAuthState('app');
      };

      const handleLogout = () => {
        setUser(null);
        setCompanyId(null);
        setSubscriptionWarning(null);
        setAuthState('login');
        setView('dashboard');
      };

      const updateDriverLocation = (driverId, location) => {
        setDrivers(prev => prev.map(d => 
          d.id === driverId ? { ...d, lastLocation: location, locationSharing: true } : d
        ));
        
        // Persist to tenant storage
        if (companyId && TENANT_DATA[companyId]) {
          const driver = TENANT_DATA[companyId].drivers.find(d => d.id === driverId);
          if (driver) {
            driver.lastLocation = location;
            driver.locationSharing = true;
            saveTenantData();
          }
        }
      };

      const stopDriverLocation = (driverId) => {
        setDrivers(prev => prev.map(d => 
          d.id === driverId ? { ...d, locationSharing: false } : d
        ));
        
        // Persist to tenant storage
        if (companyId && TENANT_DATA[companyId]) {
          const driver = TENANT_DATA[companyId].drivers.find(d => d.id === driverId);
          if (driver) {
            driver.locationSharing = false;
            saveTenantData();
          }
        }
      };

      if (authState === 'login') {
        return (
          <>
            <LoginPage lang={lang} setLang={setLang} error={loginError} onLogin={handleLogin} onGoToSignup={() => setAuthState('admin-signup')} />
            {showFaceVerify && pendingDriver && (
              <FaceVerifyModal
                lang={lang}
                driver={pendingDriver}
                onCancel={() => { setShowFaceVerify(false); setPendingDriver(null); }}
                onVerified={() => {
                  // Mark verified in tenant storage
                  if (companyId && TENANT_DATA[companyId]) {
                    const d = TENANT_DATA[companyId].drivers.find(x => x.id === pendingDriver.id);
                    if (d) {
                      d.faceVerified = true;
                      saveTenantData();
                    }
                  }
                  setUser(pendingDriver);
                  setAuthState('app');
                  setShowFaceVerify(false);
                  setPendingDriver(null);
                }}
              />
            )}
          </>
        );
      }

      if (authState === 'admin-signup') {
        return <AdminSignupPage onSignup={handleSignup} onGoToLogin={() => setAuthState('login')} />;
      }

      return (
        <div className="app">
          {subscriptionWarning && (
            <div style={{
              background: subscriptionWarning.includes('expired') ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
              color: 'white',
              padding: '0.75rem 2rem',
              textAlign: 'center',
              fontWeight: 600,
              boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
            }}>
              ‚ö†Ô∏è {subscriptionWarning}
            </div>
          )}
          <Header user={user} onLogout={handleLogout} />
          
          <div className="main-layout">
            <Sidebar view={view} onViewChange={setView} role={user.role} unreadMessages={unreadMessages} lang={lang} setLang={setLang} />
            
            <div className="content">
              {view === 'dashboard' && user.role === 'DRIVER' && (
                <DriverDashboard 
                  driver={drivers.find(d => d.id === user.id)}
                  loads={loads.filter(l => l.driverId === user.id)}
                  tasks={tasks.filter(t => t.driverId === user.id)}
                  schedule={schedule.filter(s => s.driverId === user.id)}
                  onLocationUpdate={updateDriverLocation}
                  onLocationStop={stopDriverLocation}
                  onSOS={() => {
                    setSosActive(true);
                    alert('üö® SOS ALERT SENT!\n\nAdmin has been notified of your emergency.\nEmergency services: 911\nDispatch will contact you immediately.');
                  }}
                  onViewChange={setView}
                />
              )}
              
              {view === 'schedule' && user.role === 'DRIVER' && (
                <DriverScheduleView 
                  schedule={schedule.filter(s => s.driverId === user.id)}
                  driver={drivers.find(d => d.id === user.id)}
                />
              )}
              
              {view === 'nearby' && user.role === 'DRIVER' && (
                <NearbyPlacesView 
                  driver={drivers.find(d => d.id === user.id)}
                />
              )}
              
              {view === 'profile' && user.role === 'DRIVER' && (
                <DriverProfileView 
                  driver={drivers.find(d => d.id === user.id)}
                  onUpdate={(updates) => {
                    setDrivers(drivers.map(d => d.id === user.id ? {...d, ...updates} : d));
                    alert('Profile updated successfully!');
                  }}
                />
              )}
              
              {view === 'dashboard' && user.role === 'ADMIN' && (
                <AdminDashboard drivers={drivers} loads={loads} companyId={companyId} />
              )}
              
              {view === 'drivers' && user.role === 'ADMIN' && (
                <DriversView 
                  drivers={drivers}
                  onAddDriver={() => setShowModal('createDriver')}
                  onViewDriver={(driver) => {
                    setSelectedDriver(driver);
                    setShowModal('viewDriver');
                  }}
                />
              )}
              
              {view === 'tasks' && user.role === 'ADMIN' && (
                <TasksView 
                  tasks={tasks}
                  drivers={drivers}
                  onCreateTask={() => setShowModal('createTask')}
                  onViewTask={(task) => {
                    setSelectedItem(task);
                    setShowModal('viewTask');
                  }}
                />
              )}
              
              {view === 'tasks' && user.role === 'DRIVER' && (
                <DriverTasksView 
                  tasks={tasks.filter(t => t.driverId === user.id)}
                  onUpdateStatus={(taskId, status) => {
                    setTasks(tasks.map(t => t.id === taskId ? {...t, status} : t));
                  }}
                />
              )}
              
              {view === 'inbox' && (
                <InboxView 
                  user={user}
                  messages={messages}
                  onSend={(msg) => setMessages([...messages, { ...msg, id: Date.now(), timestamp: new Date().toISOString() }])}
                  loads={loads.filter(l => user.role === 'DRIVER' ? l.driverId === user.id : true)}
                />
              )}
              
              {view === 'live-map' && user.role === 'ADMIN' && (
                <LiveTracking drivers={drivers.filter(d => d.locationSharing)} />
              )}
              
              {view === 'documents' && (
                <DocumentsView 
                  user={user}
                  loads={loads.filter(l => user.role === 'DRIVER' ? l.driverId === user.id : true)}
                  onUpload={() => setShowModal('uploadDocument')}
                />
              )}
              
              {view === 'loads' && (
                <LoadsView 
                  loads={loads.filter(l => user.role === 'DRIVER' ? l.driverId === user.id : true)}
                  isAdmin={user.role === 'ADMIN'}
                  drivers={drivers}
                  onAssignLoad={(loadId, driverId) => {
                    // Update load assignment
                    const updatedLoads = loads.map(load => {
                      if (load.id === loadId) {
                        return { ...load, driverId: driverId };
                      }
                      return load;
                    });
                    setLoads(updatedLoads);
                    
                    // Get driver info
                    const driver = drivers.find(d => d.id === driverId);
                    const load = loads.find(l => l.id === loadId);
                    
                    if (driver && load) {
                      alert(`‚úÖ Load Assigned Successfully!\n\nLoad: ${load.loadNumber}\nDriver: ${driver.name}\nTruck: ${driver.truckNumber}\n\nThe driver has been notified.`);
                    }
                  }}
                />
              )}


              {view === 'admin-profile' && user.role === 'ADMIN' && (
                <AdminProfileView 
                  lang={lang}
                  onToggleDriverEdits={(allowEdits) => {
                    // Demo: set allowEdits on all drivers (real app would be per company setting)
                    setDrivers(drivers.map(d => ({...d, allowEdits})));
                    alert(`Driver profile edits: ${allowEdits ? 'ON' : 'OFF'}`);
                  }}
                />
              )}
            </div>
          </div>

          {showModal === 'uploadDocument' && (
            <UploadDocumentModal 
              loads={loads.filter(l => user.role === 'DRIVER' ? l.driverId === user.id : true)}
              onClose={() => setShowModal(null)}
              onUpload={(docInfo) => {
                // Update loads to show document was uploaded
                const updatedLoads = loads.map(load => {
                  if (load.id === docInfo.loadId) {
                    return {
                      ...load,
                      documents: [...(load.documents || []), {
                        type: docInfo.docType,
                        fileName: docInfo.fileName,
                        uploadedAt: docInfo.uploadedAt
                      }]
                    };
                  }
                  return load;
                });
                setLoads(updatedLoads);
                setShowModal(null);
                alert(`‚úÖ Document uploaded successfully!\n\nFile: ${docInfo.fileName}\nType: ${docInfo.docType}\nValidation: ${docInfo.validation.confidence}% confidence`);
              }}
            />
          )}

          {showModal === 'createDriver' && (
            <CreateDriverModal 
              onClose={() => setShowModal(null)}
              onCreate={(newDriver) => {
                if (!companyId || !TENANT_DATA[companyId]) {
                  alert('Error: Company not found');
                  return;
                }
                
                const company = TENANT_DATA[companyId];
                
                // Check driver limit
                if (company.drivers.length >= company.subscription.maxDrivers) {
                  alert(`Driver limit reached (${company.subscription.maxDrivers} drivers). Please upgrade your plan.`);
                  return;
                }
                
                const driverId = `driver-${Date.now()}`;
                const tempPassword = newDriver.tempPassword || ('tm' + Math.floor(100000 + Math.random()*900000));
                const idNumber = newDriver.idNumber || ('D' + String(company.drivers.length + 1).padStart(3,'0'));

                // Store in tenant storage
                company.drivers.push({
                  id: driverId,
                  email: (newDriver.email || '').toLowerCase(),
                  password: tempPassword,
                  name: newDriver.name || 'Driver',
                  idNumber,
                  faceVerified: false,
                  locationSharing: false,
                  lastLocation: null,
                  earnings: {
                    totalMiles: 0,
                    ratePerMile: 0.50,
                    weeklyMiles: 0,
                    monthlyMiles: 0,
                    totalEarned: 0,
                    weeklyEarned: 0,
                    monthlyEarned: 0
                  }
                });
                
                saveTenantData();

                setDrivers([...drivers, { ...newDriver, id: driverId, idNumber, tempPassword, locationSharing: false, lastLocation: null }]);
                setShowModal(null);
                alert(`Driver account created!\n\nEmail: ${newDriver.email}\nTemporary Password: ${newDriver.tempPassword}\n\nPlease share these credentials with the driver.`);
              }}
            />
          )}

          {showModal === 'createTask' && (
            <CreateTaskModal 
              drivers={drivers}
              loads={loads}
              onClose={() => setShowModal(null)}
              onCreate={(newTask) => {
                setTasks([...tasks, { ...newTask, id: `task-${tasks.length + 1}`, createdAt: new Date().toISOString(), status: 'PENDING' }]);
                setShowModal(null);
                alert('Task assigned successfully! Driver will be notified.');
              }}
            />
          )}

          {showModal === 'viewTask' && selectedItem && (
            <ViewTaskModal 
              task={selectedItem}
              driver={drivers.find(d => d.id === selectedItem.driverId)}
              onClose={() => {
                setShowModal(null);
                setSelectedItem(null);
              }}
            />
          )}

          {showModal === 'viewDriver' && selectedDriver && (
            <ViewDriverModal 
              driver={selectedDriver}
              onClose={() => {
                setShowModal(null);
                setSelectedDriver(null);
              }}
            />
          )}

          <button className="ai-fab" onClick={() => setShowAI(!showAI)} title="AI Assistant">
            ‚ú®
          </button>

          {showAI && (
            <AIAssistant 
              user={user}
              driver={user.role === 'DRIVER' ? drivers.find(d => d.id === user.id) : null}
              loads={loads.filter(l => user.role === 'DRIVER' ? l.driverId === user.id : true)}
              locationSharing={user.role === 'DRIVER' ? drivers.find(d => d.id === user.id)?.locationSharing : false}
              drivers={drivers}
              onClose={() => setShowAI(false)}
            />
          )}
        </div>
      );
    }

    // ==========================================
    // AUTH PAGES
    // ==========================================
    
    
    function LoginPage({ lang, setLang, error, onLogin, onGoToSignup }) {
      const [role, setRole] = useState('DRIVER');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [driverId, setDriverId] = useState('');

      return (
        <div className="auth-container">
          <div className="auth-card">
            <div className="auth-logo">üöõ</div>
            <div className="auth-title">{tr(lang, 'appName')}</div>
            <div className="auth-subtitle">{tr(lang, 'signIn')}</div>

            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', gap:'0.75rem'}}>
              <div style={{fontWeight:700}}>{tr(lang, 'iam')}</div>
              <div style={{display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                <button className={'btn ' + (role==='DRIVER' ? 'btn-primary' : 'btn-outline')} style={{padding:'0.6rem 1rem'}} onClick={() => setRole('DRIVER')}>
                  üöö {tr(lang,'driver')}
                </button>
                <button className={'btn ' + (role==='ADMIN' ? 'btn-primary' : 'btn-outline')} style={{padding:'0.6rem 1rem'}} onClick={() => setRole('ADMIN')}>
                  üõ°Ô∏è {tr(lang,'admin')}
                </button>
              </div>
            </div>

            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
              <div style={{fontWeight:700}}>{tr(lang,'language')}</div>
              <select className="form-select" style={{maxWidth:180}} value={lang} onChange={(e) => setLang(e.target.value)}>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
                <option value="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              </select>
            </div>

            {error && <div className="alert alert-danger"><span>‚ö†Ô∏è</span><div>{error}</div></div>}

            <div className="form-group">
              <label className="form-label">{tr(lang,'email')}</label>
              <input className="form-input" type="email" value={email} onChange={(e) => { setEmail(e.target.value); }} placeholder="name@company.com" />
            </div>

            <div className="form-group">
              <label className="form-label">{tr(lang,'password')}</label>
              <input className="form-input" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>

            {role === 'DRIVER' && (
              <div className="form-group">
                <label className="form-label">{tr(lang,'driverId')}</label>
                <input className="form-input" value={driverId} onChange={(e) => setDriverId(e.target.value)} placeholder="D001" />
                <div style={{marginTop:'0.5rem', color:'var(--text-muted)', fontSize:'0.9rem'}}>{tr(lang,'driversHint')}</div>
              </div>
            )}

            <button className="btn btn-primary" style={{width:'100%', justifyContent:'center', minHeight:52}}
              onClick={() => onLogin(email, password, role, driverId)}>
              üîê {tr(lang,'signInBtn')}
            </button>

            <div style={{display:'flex', justifyContent:'space-between', marginTop:'1.25rem', gap:'0.75rem', flexWrap:'wrap'}}>
              <button className="btn btn-outline" style={{flex:'1 1 200px', justifyContent:'center', minHeight:52}} onClick={onGoToSignup}>
                ‚úçÔ∏è {tr(lang,'createAdmin')}
              </button>
            </div>

            <div style={{marginTop:'1rem', fontSize:'0.85rem', color:'var(--text-muted)'}}>
              Demo creds: driver@truckmate.com / driver123 / ID D001 ‚Ä¢ admin@truckmate.com / admin123
              <div style={{marginTop:'0.75rem', display:'flex', gap:'0.5rem', flexWrap:'wrap'}}>
                <button className="btn btn-outline" style={{minHeight:48}} onClick={() => { setRole('DRIVER'); setEmail('driver@truckmate.com'); setPassword('driver123'); setDriverId('D001'); }}>
                  Fill Driver Demo
                </button>
                <button className="btn btn-outline" style={{minHeight:48}} onClick={() => { setRole('ADMIN'); setEmail('admin@truckmate.com'); setPassword('admin123'); setDriverId(''); }}>
                  Fill Admin Demo
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }


function AdminSignupPage({ onSignup, onGoToLogin }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [companyName, setCompanyName] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        onSignup(email, password);
      };

      return (
        <div className="auth-container">
          <div className="auth-card">
            <div className="auth-logo">üöõ</div>
            <h1 className="auth-title">Create Admin Account</h1>
            <p className="auth-subtitle">Start managing your fleet</p>

            <form onSubmit={handleSubmit}>
              <div className="form-group">
                <label className="form-label">Company Name</label>
                <input
                  type="text"
                  className="form-input"
                  required
                  value={companyName}
                  onChange={e => setCompanyName(e.target.value)}
                  placeholder="Your Company LLC"
                />
              </div>

              <div className="form-group">
                <label className="form-label">Email</label>
                <input
                  type="email"
                  className="form-input"
                  required
                  value={email}
                  onChange={e => setEmail(e.target.value)}
                  placeholder="admin@company.com"
                />
              </div>

              <div className="form-group">
                <label className="form-label">Password</label>
                <input
                  type="password"
                  className="form-input"
                  required
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  minLength={8}
                />
              </div>

              <button type="submit" className="btn btn-primary" style={{width: '100%', marginBottom: '1rem'}}>
                Create Account
              </button>

              <div style={{textAlign: 'center'}}>
                <button type="button" className="btn btn-outline" onClick={onGoToLogin} style={{width: '100%'}}>
                  Back to Sign In
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // ==========================================
    // APP COMPONENTS
    // ==========================================
    
    
    function FaceVerifyModal({ lang, driver, onCancel, onVerified }) {
      const videoRef = useRef(null);
      const [stream, setStream] = useState(null);
      const [scanning, setScanning] = useState(false);
      const [verified, setVerified] = useState(false);

      useEffect(() => {
        return () => { 
          try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch(e) {}
        };
      }, [stream]);

      const startScan = async () => {
        setScanning(true);
        try {
          const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
          setStream(s);
          if (videoRef.current) videoRef.current.srcObject = s;
        } catch (e) {
          alert('Camera permission needed for face verification.');
          setScanning(false);
        }
      };

      const verifyNow = () => {
        // DEMO verification: always success after camera started
        setVerified(true);
        setTimeout(() => onVerified(), 600);
      };

      return (
        <div className="modal-overlay">
          <div className="modal" style={{maxWidth: 560}}>
            <div className="modal-header">
              <div className="modal-title">{tr(lang,'faceVerifyTitle')}</div>
              <button className="modal-close" onClick={onCancel}>√ó</button>
            </div>
            <div className="modal-body">
              <div style={{fontWeight:700, marginBottom:'0.5rem'}}>{driver?.name}</div>
              <div style={{color:'var(--text-muted)'}}>{tr(lang,'faceVerifyDesc')}</div>

              {!scanning ? (
                <div style={{marginTop:'1.25rem', display:'flex', gap:'0.75rem', flexWrap:'wrap'}}>
                  <button className="btn btn-primary" style={{minHeight:52}} onClick={startScan}>
                    üì∑ {tr(lang,'startScan')}
                  </button>
                  <button className="btn btn-outline" style={{minHeight:52}} onClick={onVerified} title="Demo fallback">
                    Skip (demo)
                  </button>
                </div>
              ) : (
                <div style={{marginTop:'1rem'}}>
                  <video className="video-preview" ref={videoRef} autoPlay playsInline />
                  <div style={{display:'flex', gap:'0.75rem', marginTop:'0.75rem', flexWrap:'wrap'}}>
                    <button className="btn btn-success" style={{minHeight:52}} onClick={verifyNow}>
                      ‚úÖ {verified ? tr(lang,'verified') : tr(lang,'verify')}
                    </button>
                    <button className="btn btn-outline" style={{minHeight:52}} onClick={onCancel}>Cancel</button>
                  </div>
                  <div style={{marginTop:'0.75rem', fontSize:'0.85rem', color:'var(--text-muted)'}}>
                    Safety note: Only scan when parked.
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }



    function Header({ user, onLogout, lang, setLang }) {
      return (
        <header className="header">
          <div className="header-content">
            <div className="logo">üöõ {tr(lang,'appName')}</div>
            <div style={{display:'flex', alignItems:'center', gap:'0.75rem'}}>
              <select className="form-select" style={{maxWidth: 170, background:'rgba(255,255,255,0.15)', color:'white', borderColor:'rgba(255,255,255,0.25)'}}
                value={lang}
                onChange={(e) => setLang(e.target.value)}
              >
                <option value="en">EN</option>
                <option value="es">ES</option>
                <option value="pa">PA</option>
              </select>

              <div className="user-menu" title="Account menu">
                <div className="user-avatar">{(user?.name || 'U')[0].toUpperCase()}</div>
                <div>
                  <div style={{ fontWeight: 700 }}>{user?.name}</div>
                  <div style={{ fontSize: '0.85rem', opacity: 0.9 }}>
                    {user?.role} ‚Ä¢ <span style={{textDecoration:'underline', cursor:'pointer'}} onClick={onLogout}>{tr(lang,'logout')}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>
      );
    }



    
    function Sidebar({ view, onViewChange, role, unreadMessages = 0, lang = 'en', setLang }) {
      const isAdmin = role === 'ADMIN';

      const adminNav = [
        { key: 'dashboard', labelKey: 'dashboard', icon: 'üìä', page: 'dashboard' },
        { key: 'drivers', labelKey: 'drivers', icon: 'üë•', page: 'drivers' },
        { key: 'loads', labelKey: 'loads', icon: 'üì¶', page: 'loads' },
        { key: 'live', labelKey: 'liveMap', icon: 'üó∫Ô∏è', page: 'live-map' },
        { key: 'inbox', labelKey: 'inbox', icon: 'üí¨', page: 'inbox', badgeFrom: 'unread' },
        { key: 'documents', labelKey: 'documents', icon: 'üìÑ', page: 'documents' },
        { key: 'tasks', labelKey: 'tasks', icon: '‚úÖ', page: 'tasks' },
        { key: 'profile', labelKey: 'profile', icon: '‚öôÔ∏è', page: 'admin-profile' },
      ];

      const driverNav = [
        { key: 'dashboard', labelKey: 'dashboard', icon: 'üè†', page: 'dashboard' },
        { key: 'schedule', labelKey: 'schedule', icon: 'üóìÔ∏è', page: 'schedule' },
        { key: 'loads', labelKey: 'loads', icon: 'üì¶', page: 'loads' },
        { key: 'tasks', labelKey: 'tasks', icon: '‚úÖ', page: 'tasks' },
        { key: 'nearby', labelKey: 'nearby', icon: 'üìç', page: 'nearby' },
        { key: 'inbox', labelKey: 'inbox', icon: 'üí¨', page: 'inbox', badgeFrom: 'unread' },
        { key: 'documents', labelKey: 'documents', icon: 'üìÑ', page: 'documents' },
        { key: 'profile', labelKey: 'profile', icon: 'üë§', page: 'profile' },
      ];

      const items = isAdmin ? adminNav : driverNav;

      return (
        <aside className="sidebar">
          {items.map(item => {
            const badge = item.badgeFrom === 'unread' ? unreadMessages : item.badge;
            return (
              <div
                key={item.key}
                className={'nav-item ' + (view === item.page ? 'active' : '')}
                onClick={() => onViewChange(item.page)}
                role="button"
                tabIndex={0}
                onKeyDown={(e) => { if (e.key === 'Enter' || e.key === ' ') onViewChange(item.page); }}
              >
                <span>{item.icon}</span>
                <span>{tr(lang, item.labelKey)}</span>
                {badge ? <span className="badge">{badge}</span> : null}
              </div>
            );
          })}
          
          {/* Language Selector */}
          <div style={{
            padding: '1rem',
            borderTop: '2px solid var(--border)',
            marginTop: 'auto'
          }}>
            <label style={{
              display: 'block',
              fontSize: '0.75rem',
              fontWeight: 600,
              color: 'var(--text-muted)',
              marginBottom: '0.5rem',
              textTransform: 'uppercase',
              letterSpacing: '0.05em'
            }}>
              üåç {tr(lang, 'language')}
            </label>
            <select
              value={lang}
              onChange={(e) => setLang(e.target.value)}
              style={{
                width: '100%',
                padding: '0.75rem',
                border: '2px solid var(--border)',
                borderRadius: '8px',
                fontSize: '0.95rem',
                fontWeight: 600,
                background: 'white',
                cursor: 'pointer',
                transition: 'all 0.2s'
              }}
            >
              <option value="en">üá∫üá∏ English</option>
              <option value="es">üá≤üáΩ Espa√±ol</option>
              <option value="pa">üáÆüá≥ ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
              <option value="hi">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
            </select>
          </div>
        </aside>
      );
    }


    function DriverDashboard({ driver, loads, tasks, schedule, onLocationUpdate, onLocationStop, onSOS, onViewChange }) {
      const [locationSharing, setLocationSharing] = useState(driver?.locationSharing || false);
      const [currentLocation, setCurrentLocation] = useState(null);
      const [error, setError] = useState(null);
      const [hoursWorked, setHoursWorked] = useState(7.5); // Mock data
      const [driverStatus, setDriverStatus] = useState(driver?.currentStatus || 'OFF_DUTY'); // DRIVING, SLEEPING, ON_BREAK, OFF_DUTY

      // Sync location sharing state with driver prop changes
      useEffect(() => {
        if (driver?.locationSharing !== undefined) {
          setLocationSharing(driver.locationSharing);
        }
        if (driver?.currentStatus) {
          setDriverStatus(driver.currentStatus);
        }
      }, [driver?.locationSharing, driver?.currentStatus]);

      // Update driver status in storage and notify admin
      const updateDriverStatus = (newStatus) => {
        setDriverStatus(newStatus);
        
        // Save to tenant storage
        const data = JSON.parse(localStorage.getItem('truckmate_tenants_v2'));
        for (const [companyId, company] of Object.entries(data)) {
          const driverInCompany = company.drivers.find(d => d.id === driver.id);
          if (driverInCompany) {
            driverInCompany.currentStatus = newStatus;
            driverInCompany.statusChangedAt = new Date().toISOString();
            localStorage.setItem('truckmate_tenants_v2', JSON.stringify(data));
            
            // Create notification for admin
            const notifications = JSON.parse(localStorage.getItem('truckmate_notifications') || '[]');
            notifications.push({
              id: `notif-${Date.now()}`,
              companyId: companyId,
              driverId: driver.id,
              driverName: driver.name,
              type: 'STATUS_CHANGE',
              status: newStatus,
              timestamp: new Date().toISOString(),
              read: false
            });
            localStorage.setItem('truckmate_notifications', JSON.stringify(notifications));
            break;
          }
        }
      };

      useEffect(() => {
        let watchId;
        
        if (locationSharing && navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              const loc = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                speed: position.coords.speed,
                timestamp: new Date().toISOString()
              };
              setCurrentLocation(loc);
              onLocationUpdate(driver.id, loc);
              setError(null);
            },
            (err) => {
              setError(err.message);
              setLocationSharing(false);
              onLocationStop(driver.id);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        }

        return () => {
          if (watchId) navigator.geolocation.clearWatch(watchId);
        };
      }, [locationSharing, driver?.id]);

      const toggleLocation = () => {
        if (!navigator.geolocation) {
          setError('Geolocation not supported');
          return;
        }
        
        const newState = !locationSharing;
        setLocationSharing(newState);
        
        if (newState) {
          // Will start in useEffect above
        } else {
          onLocationStop(driver.id);
        }
      };

      const hoursRemaining = 11 - hoursWorked;
      const needsBreak = hoursWorked >= 8;

      const pendingTasks = tasks?.filter(t => t.status === 'PENDING').length || 0;
      const todaySchedule = schedule?.filter(s => {
        const schedDate = new Date(s.date).toDateString();
        const today = new Date().toDateString();
        return schedDate === today;
      }).length || 0;

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
            <h1 style={{fontSize: '2rem', fontWeight: 900}}>
              Welcome, {driver.name.split(' ')[0]}!
            </h1>
            
            {/* Emergency SOS Button */}
            <button 
              className="btn btn-danger"
              onClick={onSOS}
              style={{fontSize: '1rem', padding: '1rem 2rem', fontWeight: 700}}
            >
              üö® EMERGENCY SOS
            </button>
          </div>

          {/* Hours of Service Tracker */}
          <div className="card" style={{background: needsBreak ? 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)' : 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', border: needsBreak ? '2px solid var(--danger)' : '2px solid var(--primary)', marginBottom: '1.5rem'}}>
            <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
              ‚è∞ Hours of Service Status
            </h3>
            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '1.5rem'}}>
              <div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--primary)'}}>
                  {hoursWorked}h
                </div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>
                  HOURS WORKED TODAY
                </div>
              </div>
              <div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: hoursRemaining < 2 ? 'var(--danger)' : 'var(--success)'}}>
                  {hoursRemaining}h
                </div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>
                  HOURS REMAINING
                </div>
              </div>
              <div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: needsBreak ? 'var(--danger)' : 'var(--success)'}}>
                  {needsBreak ? 'REQUIRED' : 'NOT YET'}
                </div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>
                  30-MIN BREAK
                </div>
              </div>
            </div>
            {needsBreak && (
              <div style={{marginTop: '1rem', padding: '1rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '8px', color: '#991b1b', fontWeight: 600}}>
                ‚ö†Ô∏è You must take a 30-minute break before continuing to drive
              </div>
            )}
            <div style={{marginTop: '1rem', fontSize: '0.875rem', color: 'var(--text-muted)'}}>
              Estimate only ‚Äî not an official ELD record. Always follow your ELD for compliance.
            </div>
          </div>

          {/* Quick Actions */}
          <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem'}}>
            <button 
              className="btn btn-primary"
              onClick={() => onViewChange('nearby')}
              style={{padding: '1rem', fontSize: '1rem'}}
            >
              ‚õΩ Find Fuel Stops
            </button>
            <button 
              className="btn btn-primary"
              onClick={() => onViewChange('nearby')}
              style={{padding: '1rem', fontSize: '1rem'}}
            >
              üçî Find Food
            </button>
            <button 
              className="btn btn-primary"
              onClick={() => onViewChange('schedule')}
              style={{padding: '1rem', fontSize: '1rem'}}
            >
              üìÖ View Schedule
            </button>
            <button 
              className="btn btn-primary"
              onClick={() => onViewChange('loads')}
              style={{padding: '1rem', fontSize: '1rem'}}
            >
              üì¶ My Loads
            </button>
          </div>

          {/* Earnings Card */}
          <div className="card" style={{marginBottom: '2rem', background: 'linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%)', border: '2px solid var(--success)'}}>
            <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
              üí∞ Earnings
            </h3>
            
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1.5rem', marginBottom: '1.5rem'}}>
              <div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                  RATE PER MILE
                </div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--success)'}}>
                  ${driver?.earnings?.ratePerMile?.toFixed(2) || '0.50'}
                </div>
              </div>
              
              <div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                  TOTAL MILES
                </div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--primary)'}}>
                  {driver?.earnings?.totalMiles?.toLocaleString() || '0'}
                </div>
              </div>
              
              <div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                  TOTAL EARNED
                </div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--success)'}}>
                  ${driver?.earnings?.totalEarned?.toLocaleString() || '0'}
                </div>
              </div>
            </div>
            
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem', paddingTop: '1rem', borderTop: '1px solid rgba(16, 185, 129, 0.2)'}}>
              <div style={{textAlign: 'center', padding: '0.75rem', background: 'rgba(255,255,255,0.5)', borderRadius: '8px'}}>
                <div style={{fontSize: '1.25rem', fontWeight: 700, color: 'var(--primary)'}}>
                  {driver?.earnings?.weeklyMiles || '0'}
                </div>
                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>This Week</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--success)', marginTop: '0.25rem'}}>
                  ${driver?.earnings?.weeklyEarned || '0'}
                </div>
              </div>
              
              <div style={{textAlign: 'center', padding: '0.75rem', background: 'rgba(255,255,255,0.5)', borderRadius: '8px'}}>
                <div style={{fontSize: '1.25rem', fontWeight: 700, color: 'var(--primary)'}}>
                  {driver?.earnings?.monthlyMiles?.toLocaleString() || '0'}
                </div>
                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>This Month</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--success)', marginTop: '0.25rem'}}>
                  ${driver?.earnings?.monthlyEarned?.toLocaleString() || '0'}
                </div>
              </div>
              
              <div style={{textAlign: 'center', padding: '0.75rem', background: 'rgba(255,255,255,0.5)', borderRadius: '8px'}}>
                <div style={{fontSize: '1.25rem', fontWeight: 700, color: 'var(--primary)'}}>
                  {driver?.earnings?.totalMiles?.toLocaleString() || '0'}
                </div>
                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>All Time</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--success)', marginTop: '0.25rem'}}>
                  ${driver?.earnings?.totalEarned?.toLocaleString() || '0'}
                </div>
              </div>
            </div>
            
            <div style={{marginTop: '1rem', padding: '1rem', background: 'rgba(16, 185, 129, 0.1)', borderRadius: '8px', fontSize: '0.875rem', textAlign: 'center'}}>
              <strong>üí° Pro Tip:</strong> Complete more loads to increase your earnings! Each mile = $0.50
            </div>
          </div>

          {/* Location Sharing */}
          <div className={locationSharing ? 'card location-card' : 'card location-card off'}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
              <div style={{flex: 1}}>
                <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>
                  üìç Location Sharing: {locationSharing ? 'ON' : 'OFF'}
                </h3>
                <p style={{fontSize: '0.95rem', marginBottom: '1rem', color: locationSharing ? '#065f46' : 'var(--text-muted)'}}>
                  {locationSharing 
                    ? 'Admin can see your location. You control this - turn OFF anytime.'
                    : 'Location sharing is OFF. Admin cannot see your location.'}
                </p>
                
                {currentLocation && locationSharing && (
                  <div style={{padding: '1rem', background: 'rgba(255,255,255,0.6)', borderRadius: '8px', fontSize: '0.875rem'}}>
                    <strong>Live Location:</strong>
                    <div>Lat: {currentLocation.lat.toFixed(6)}, Lng: {currentLocation.lng.toFixed(6)}</div>
                    <div>Last update: {new Date(currentLocation.timestamp).toLocaleTimeString()}</div>
                  </div>
                )}
                
                {error && (
                  <div className="alert alert-danger" style={{marginTop: '1rem'}}>
                    <span>‚ö†</span>
                    <div><strong>Error:</strong> {error}</div>
                  </div>
                )}
              </div>
              
              <button 
                className={`btn ${locationSharing ? 'btn-danger' : 'btn-success'}`}
                onClick={toggleLocation}
                style={{padding: '1rem 2rem'}}
              >
                {locationSharing ? 'üõë Stop Sharing' : 'üìç Start Sharing'}
              </button>
            </div>
          </div>

          {/* Driver Status Selector */}
          <div className="card" style={{marginBottom: '2rem', background: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)', border: '2px solid var(--primary)'}}>
            <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
              üö¶ Current Status
            </h3>
            <p style={{fontSize: '0.95rem', marginBottom: '1rem', color: 'var(--text-muted)'}}>
              Update your status to let dispatch know what you're doing. This helps with scheduling and compliance.
            </p>
            
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '1rem'}}>
              <button
                className={`btn ${driverStatus === 'DRIVING' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => updateDriverStatus('DRIVING')}
                style={{padding: '1rem', fontSize: '1rem', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem'}}
              >
                <span style={{fontSize: '2rem'}}>üöõ</span>
                <span>Driving</span>
              </button>
              
              <button
                className={`btn ${driverStatus === 'ON_BREAK' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => updateDriverStatus('ON_BREAK')}
                style={{padding: '1rem', fontSize: '1rem', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem'}}
              >
                <span style={{fontSize: '2rem'}}>‚òï</span>
                <span>On Break</span>
              </button>
              
              <button
                className={`btn ${driverStatus === 'SLEEPING' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => updateDriverStatus('SLEEPING')}
                style={{padding: '1rem', fontSize: '1rem', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem'}}
              >
                <span style={{fontSize: '2rem'}}>üò¥</span>
                <span>Sleeping</span>
              </button>
              
              <button
                className={`btn ${driverStatus === 'OFF_DUTY' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => updateDriverStatus('OFF_DUTY')}
                style={{padding: '1rem', fontSize: '1rem', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem'}}
              >
                <span style={{fontSize: '2rem'}}>üè†</span>
                <span>Off Duty</span>
              </button>
            </div>
            
            <div style={{marginTop: '1rem', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px', fontSize: '0.875rem'}}>
              <strong>Current:</strong> {
                driverStatus === 'DRIVING' ? 'üöõ Driving' :
                driverStatus === 'ON_BREAK' ? '‚òï On Break' :
                driverStatus === 'SLEEPING' ? 'üò¥ Sleeping' :
                'üè† Off Duty'
              } ‚Ä¢ Admin has been notified
            </div>
          </div>

          {/* Stats */}
          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-value">{loads.length}</div>
              <div className="stat-label">Active Loads</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--warning)'}}>{pendingTasks}</div>
              <div className="stat-label">Pending Tasks</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{todaySchedule}</div>
              <div className="stat-label">Today's Schedule</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">1,260</div>
              <div className="stat-label">Total Miles</div>
            </div>
          </div>

          {/* Active Load */}
          {loads.filter(l => l.status === 'ASSIGNED').length > 0 && (
            <div className="card" style={{background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: '2px solid var(--warning)'}}>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
                üöö Active Load: {loads[0].loadNumber}
              </h3>
              <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem'}}>
                <div>
                  <strong>üìç Pickup:</strong> {loads[0].pickupLocation}
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>{loads[0].pickupAddress}</div>
                </div>
                <div>
                  <strong>üéØ Delivery:</strong> {loads[0].deliveryLocation}
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>{loads[0].deliveryAddress}</div>
                </div>
              </div>
              <button 
                className="btn btn-success"
                onClick={() => window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(loads[0].pickupAddress)}&destination=${encodeURIComponent(loads[0].deliveryAddress)}&travelmode=driving`, '_blank')}
                style={{marginTop: '1rem'}}
              >
                üó∫Ô∏è Navigate Now
              </button>
            </div>
          )}
        </div>
      );
    }

    function AdminDashboard({ drivers, loads, companyId }) {
      const sharingLocation = drivers.filter(d => d.locationSharing).length;
      const [notifications, setNotifications] = useState([]);
      const [showNotifications, setShowNotifications] = useState(true);
      
      // Get company subscription info
      const company = companyId ? TENANT_DATA[companyId] : null;
      const subscription = company?.subscription;
      
      // Load notifications for this company
      useEffect(() => {
        const loadNotifications = () => {
          const allNotifs = JSON.parse(localStorage.getItem('truckmate_notifications') || '[]');
          const companyNotifs = allNotifs
            .filter(n => n.companyId === companyId)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 10); // Show latest 10
          setNotifications(companyNotifs);
        };
        
        loadNotifications();
        
        // Refresh notifications every 5 seconds
        const interval = setInterval(loadNotifications, 5000);
        return () => clearInterval(interval);
      }, [companyId]);
      
      const markAsRead = (notifId) => {
        const allNotifs = JSON.parse(localStorage.getItem('truckmate_notifications') || '[]');
        const updated = allNotifs.map(n => n.id === notifId ? {...n, read: true} : n);
        localStorage.setItem('truckmate_notifications', JSON.stringify(updated));
        setNotifications(notifications.map(n => n.id === notifId ? {...n, read: true} : n));
      };
      
      const clearNotification = (notifId) => {
        const allNotifs = JSON.parse(localStorage.getItem('truckmate_notifications') || '[]');
        const filtered = allNotifs.filter(n => n.id !== notifId);
        localStorage.setItem('truckmate_notifications', JSON.stringify(filtered));
        setNotifications(notifications.filter(n => n.id !== notifId));
      };
      
      const unreadCount = notifications.filter(n => !n.read).length;
      
      // Get driver status counts
      const drivingCount = drivers.filter(d => d.currentStatus === 'DRIVING').length;
      const sleepingCount = drivers.filter(d => d.currentStatus === 'SLEEPING').length;
      const onBreakCount = drivers.filter(d => d.currentStatus === 'ON_BREAK').length;
      const offDutyCount = drivers.filter(d => d.currentStatus === 'OFF_DUTY' || !d.currentStatus).length;
      
      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>Admin Dashboard</h1>
          
          {subscription && (
            <div className="card" style={{
              marginBottom: '2rem',
              background: subscription.status === 'active' ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
              border: `2px solid ${subscription.status === 'active' ? 'var(--success)' : 'var(--danger)'}`
            }}>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
                üìã Subscription Status
              </h3>
              <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                <div>
                  <div style={{fontSize: '1.5rem', fontWeight: 900, color: 'var(--primary)'}}>
                    {subscription.plan.toUpperCase()}
                  </div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Plan Type</div>
                </div>
                <div>
                  <div style={{fontSize: '1.5rem', fontWeight: 900, color: subscription.status === 'active' ? 'var(--success)' : 'var(--danger)'}}>
                    {subscription.status.toUpperCase()}
                  </div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Status</div>
                </div>
                <div>
                  <div style={{fontSize: '1.5rem', fontWeight: 900, color: 'var(--primary)'}}>
                    {drivers.length} / {subscription.maxDrivers}
                  </div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Drivers Used</div>
                </div>
                <div>
                  <div style={{fontSize: '1.5rem', fontWeight: 900, color: 'var(--warning)'}}>
                    {new Date(subscription.expiresAt).toLocaleDateString()}
                  </div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Expires On</div>
                </div>
              </div>
            </div>
          )}
          
          {/* Driver Status Overview */}
          <div className="card" style={{marginBottom: '2rem', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: '2px solid var(--warning)'}}>
            <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>
              üö¶ Driver Status Overview
            </h3>
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1rem'}}>
              <div style={{textAlign: 'center'}}>
                <div style={{fontSize: '2.5rem', marginBottom: '0.5rem'}}>üöõ</div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--primary)'}}>{drivingCount}</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>DRIVING</div>
              </div>
              <div style={{textAlign: 'center'}}>
                <div style={{fontSize: '2.5rem', marginBottom: '0.5rem'}}>‚òï</div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--warning)'}}>{onBreakCount}</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>ON BREAK</div>
              </div>
              <div style={{textAlign: 'center'}}>
                <div style={{fontSize: '2.5rem', marginBottom: '0.5rem'}}>üò¥</div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--success)'}}>{sleepingCount}</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>SLEEPING</div>
              </div>
              <div style={{textAlign: 'center'}}>
                <div style={{fontSize: '2.5rem', marginBottom: '0.5rem'}}>üè†</div>
                <div style={{fontSize: '2rem', fontWeight: 900, color: 'var(--text-muted)'}}>{offDutyCount}</div>
                <div style={{fontSize: '0.875rem', fontWeight: 600, color: 'var(--text-muted)'}}>OFF DUTY</div>
              </div>
            </div>
          </div>
          
          {/* Real-time Notifications */}
          {notifications.length > 0 && (
            <div className="card" style={{marginBottom: '2rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                <h3 style={{fontSize: '1.25rem', fontWeight: 700}}>
                  üîî Driver Status Notifications {unreadCount > 0 && (
                    <span style={{
                      background: 'var(--danger)',
                      color: 'white',
                      padding: '0.25rem 0.75rem',
                      borderRadius: '12px',
                      fontSize: '0.875rem',
                      marginLeft: '0.5rem'
                    }}>
                      {unreadCount} new
                    </span>
                  )}
                </h3>
                <button 
                  className="btn btn-outline"
                  onClick={() => setShowNotifications(!showNotifications)}
                  style={{padding: '0.5rem 1rem'}}
                >
                  {showNotifications ? 'Hide' : 'Show'}
                </button>
              </div>
              
              {showNotifications && (
                <div style={{display: 'grid', gap: '0.75rem'}}>
                  {notifications.map(notif => (
                    <div 
                      key={notif.id}
                      style={{
                        padding: '1rem',
                        background: notif.read ? 'var(--bg)' : '#dbeafe',
                        border: `1px solid ${notif.read ? 'var(--border)' : 'var(--primary)'}`,
                        borderRadius: '8px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'start'
                      }}
                    >
                      <div style={{flex: 1}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                          <span style={{fontSize: '1.5rem'}}>
                            {notif.status === 'DRIVING' ? 'üöõ' :
                             notif.status === 'ON_BREAK' ? '‚òï' :
                             notif.status === 'SLEEPING' ? 'üò¥' : 'üè†'}
                          </span>
                          <strong>{notif.driverName}</strong>
                          <span style={{color: 'var(--text-muted)'}}>‚Üí</span>
                          <span style={{fontWeight: 600, color: 'var(--primary)'}}>
                            {notif.status.replace('_', ' ')}
                          </span>
                        </div>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                          {new Date(notif.timestamp).toLocaleString()}
                        </div>
                      </div>
                      <div style={{display: 'flex', gap: '0.5rem'}}>
                        {!notif.read && (
                          <button
                            className="btn btn-outline"
                            onClick={() => markAsRead(notif.id)}
                            style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                          >
                            Mark Read
                          </button>
                        )}
                        <button
                          className="btn btn-outline"
                          onClick={() => clearNotification(notif.id)}
                          style={{padding: '0.5rem 1rem', fontSize: '0.875rem', color: 'var(--danger)', borderColor: 'var(--danger)'}}
                        >
                          ‚úï
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          
          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-value">{drivers.length}</div>
              <div className="stat-label">Total Drivers</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{drivers.filter(d => d.status === 'ACTIVE').length}</div>
              <div className="stat-label">Active Drivers</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{sharingLocation}</div>
              <div className="stat-label">Sharing Location</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{loads.length}</div>
              <div className="stat-label">Active Loads</div>
            </div>
          </div>

          <div className="alert alert-success">
            <span>‚úÖ</span>
            <div>
              <strong>System Status: Online</strong>
              <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                All systems operational. {sharingLocation} drivers sharing location. Click "Live Tracking" to view map.
              </div>
            </div>
          </div>
        </div>
      );
    }

    function InboxView({ user, messages, onSend, loads }) {
      const [selectedThread, setSelectedThread] = useState('general');
      const [newMessage, setNewMessage] = useState('');

      const threads = [
        { id: 'general', name: user.role === 'DRIVER' ? 'Dispatch' : 'General Messages', type: 'general' },
        ...loads.map(load => ({
          id: `load-${load.id}`,
          name: `Load ${load.loadNumber}`,
          type: 'load',
          load
        }))
      ];

      const threadMessages = messages.filter(m => 
        m.threadId === selectedThread
      );

      const handleSend = () => {
        if (!newMessage.trim()) return;
        
        onSend({
          threadId: selectedThread,
          content: newMessage,
          sender: user.role,
          senderName: user.name
        });
        setNewMessage('');
      };

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>Inbox</h1>

          <div style={{display: 'grid', gridTemplateColumns: '300px 1fr', gap: '1.5rem'}}>
            {/* Thread List */}
            <div className="card">
              <h3 style={{fontWeight: 700, marginBottom: '1rem'}}>Conversations</h3>
              {threads.map(thread => (
                <div
                  key={thread.id}
                  onClick={() => setSelectedThread(thread.id)}
                  style={{
                    padding: '1rem',
                    marginBottom: '0.5rem',
                    background: selectedThread === thread.id ? 'var(--primary-light)' : 'var(--bg)',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: selectedThread === thread.id ? 700 : 400,
                    color: selectedThread === thread.id ? 'var(--primary)' : 'var(--text)'
                  }}
                >
                  {thread.type === 'general' ? 'üí¨' : 'üì¶'} {thread.name}
                </div>
              ))}
            </div>

            {/* Messages */}
            <div className="card">
              <h3 style={{fontWeight: 700, marginBottom: '1rem'}}>
                {threads.find(t => t.id === selectedThread)?.name}
              </h3>

              <div className="message-list">
                {threadMessages.length === 0 ? (
                  <div style={{textAlign: 'center', padding: '3rem', color: 'var(--text-muted)'}}>
                    <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üí¨</div>
                    <div>No messages yet</div>
                    <div style={{fontSize: '0.875rem'}}>Start a conversation with dispatch</div>
                  </div>
                ) : (
                  threadMessages.map(msg => (
                    <div key={msg.id} className={`message ${msg.sender === user.role ? 'sent' : 'received'}`}>
                      <div className="message-avatar">
                        {msg.senderName[0]}
                      </div>
                      <div>
                        <div className="message-bubble">
                          <div style={{fontWeight: 600, marginBottom: '0.25rem', fontSize: '0.875rem'}}>
                            {msg.senderName}
                          </div>
                          <div>{msg.content}</div>
                        </div>
                        <div className="message-time">
                          {new Date(msg.timestamp).toLocaleString()}
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>

              <div style={{display: 'flex', gap: '0.5rem'}}>
                <input
                  className="form-input"
                  placeholder="Type your message..."
                  value={newMessage}
                  onChange={e => setNewMessage(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && handleSend()}
                  style={{flex: 1, marginBottom: 0}}
                />
                <button className="btn btn-primary" onClick={handleSend}>
                  Send
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function LiveTracking({ drivers }) {
      const mapRef = useRef(null);
      const [map, setMap] = useState(null);

      useEffect(() => {
        if (!mapRef.current || map) return;

        const leafletMap = L.map(mapRef.current).setView([39.8283, -98.5795], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(leafletMap);
        setMap(leafletMap);
      }, []);

      useEffect(() => {
        if (!map) return;

        map.eachLayer(layer => {
          if (layer instanceof L.Marker) layer.remove();
        });

        drivers.forEach(driver => {
          if (driver.lastLocation) {
            L.marker([driver.lastLocation.lat, driver.lastLocation.lng])
              .addTo(map)
              .bindPopup(`<strong>${driver.name}</strong><br/>${driver.truckNumber}<br/>Status: ${driver.status}`);
          }
        });

        if (drivers.length > 0 && drivers[0].lastLocation) {
          const bounds = drivers.filter(d => d.lastLocation).map(d => [d.lastLocation.lat, d.lastLocation.lng]);
          if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        }
      }, [map, drivers]);

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>Live Driver Tracking</h1>
          
          <div className="alert alert-success">
            <span>üìç</span>
            <div>
              <strong>{drivers.length} Drivers Sharing Location</strong>
              <div style={{fontSize: '0.875rem'}}>Real-time updates every 30 seconds</div>
            </div>
          </div>

          {drivers.length === 0 ? (
            <div className="card" style={{textAlign: 'center', padding: '3rem'}}>
              <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üìç</div>
              <h3 style={{marginBottom: '0.5rem'}}>No Drivers Sharing Location</h3>
              <p style={{color: 'var(--text-muted)'}}>Drivers must enable location sharing from their dashboard</p>
            </div>
          ) : (
            <div ref={mapRef} className="map-container"></div>
          )}
        </div>
      );
    }

    function DocumentsView({ user, loads, onUpload }) {
      // Get all uploaded documents from loads
      const allDocuments = [];
      loads.forEach(load => {
        if (load.documents && load.documents.length > 0) {
          load.documents.forEach(doc => {
            allDocuments.push({
              ...doc,
              loadNumber: load.loadNumber,
              loadRoute: `${load.pickupLocation} ‚Üí ${load.deliveryLocation}`
            });
          });
        }
      });
      
      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '2rem'}}>
            <h1 style={{fontSize: '2rem', fontWeight: 900}}>Documents</h1>
            {user.role === 'DRIVER' && (
              <button className="btn btn-primary" onClick={onUpload}>
                üì§ Upload Document
              </button>
            )}
          </div>

          {allDocuments.length === 0 ? (
            <div className="card" style={{textAlign: 'center', padding: '3rem'}}>
              <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üìÑ</div>
              <h3 style={{marginBottom: '0.5rem'}}>No Documents Yet</h3>
              <p style={{color: 'var(--text-muted)'}}>Upload your first document to get started</p>
            </div>
          ) : (
            <div className="card">
              <table className="table">
                <thead>
                  <tr>
                    <th>Document</th>
                    <th>Type</th>
                    <th>Load</th>
                    <th>Uploaded</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {allDocuments.map((doc, idx) => (
                    <tr key={idx}>
                      <td>
                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                          <span style={{fontSize: '1.5rem'}}>üìÑ</span>
                          <strong>{doc.fileName}</strong>
                        </div>
                      </td>
                      <td><span className="badge badge-primary">{doc.type}</span></td>
                      <td>
                        <div>{doc.loadNumber}</div>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>{doc.loadRoute}</div>
                      </td>
                      <td>{new Date(doc.uploadedAt).toLocaleDateString()}</td>
                      <td>
                        <button className="btn btn-outline" style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}>
                          View
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    }

    function LoadsView({ loads, isAdmin, drivers, onAssignLoad }) {
      const [showAssignModal, setShowAssignModal] = useState(false);
      const [selectedLoad, setSelectedLoad] = useState(null);
      
      const handleAssignClick = (load) => {
        setSelectedLoad(load);
        setShowAssignModal(true);
      };
      
      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>
            {isAdmin ? 'All Loads' : 'My Loads'}
          </h1>

          <div className="card">
            <table className="table">
              <thead>
                <tr>
                  <th>Load #</th>
                  <th>Route</th>
                  {isAdmin && <th>Assigned Driver</th>}
                  <th>Distance</th>
                  <th>Pay</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {loads.map(load => {
                  const assignedDriver = drivers?.find(d => d.id === load.driverId);
                  return (
                    <tr key={load.id}>
                      <td><strong>{load.loadNumber}</strong></td>
                      <td>{load.pickupLocation} ‚Üí {load.deliveryLocation}</td>
                      {isAdmin && (
                        <td>
                          {assignedDriver ? (
                            <div>
                              <strong>{assignedDriver.name}</strong>
                              <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                                {assignedDriver.truckNumber}
                              </div>
                            </div>
                          ) : (
                            <span style={{color: 'var(--text-muted)', fontStyle: 'italic'}}>Unassigned</span>
                          )}
                        </td>
                      )}
                      <td>{load.distance} mi</td>
                      <td style={{color: 'var(--success)', fontWeight: 700}}>${load.estimatedPay}</td>
                      <td><span className={`badge badge-${load.status.toLowerCase()}`}>{load.status}</span></td>
                      <td>
                        <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                          {isAdmin && (
                            <button 
                              className="btn btn-primary"
                              onClick={() => handleAssignClick(load)}
                              style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                            >
                              {assignedDriver ? 'üîÑ Reassign' : 'üë§ Assign'}
                            </button>
                          )}
                          <button 
                            className="btn btn-outline"
                            onClick={() => window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(load.pickupAddress)}&destination=${encodeURIComponent(load.deliveryAddress)}&travelmode=driving`, '_blank')}
                            style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                          >
                            üó∫Ô∏è Navigate
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          
          {showAssignModal && selectedLoad && (
            <AssignLoadModal 
              load={selectedLoad}
              drivers={drivers}
              currentDriverId={selectedLoad.driverId}
              onClose={() => {
                setShowAssignModal(false);
                setSelectedLoad(null);
              }}
              onAssign={(driverId) => {
                onAssignLoad(selectedLoad.id, driverId);
                setShowAssignModal(false);
                setSelectedLoad(null);
              }}
            />
          )}
        </div>
      );
    }

    function AssignLoadModal({ load, drivers, currentDriverId, onClose, onAssign }) {
      const [selectedDriverId, setSelectedDriverId] = useState(currentDriverId || '');
      const [searchTerm, setSearchTerm] = useState('');
      
      // Filter drivers by search term and status
      const availableDrivers = drivers.filter(d => 
        d.status === 'ACTIVE' && (
          d.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          d.truckNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
          d.email.toLowerCase().includes(searchTerm.toLowerCase())
        )
      );
      
      const handleSubmit = (e) => {
        e.preventDefault();
        if (selectedDriverId) {
          onAssign(selectedDriverId);
        }
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '600px'}}>
            <div className="modal-header">
              <h3 className="modal-title">üë§ Assign Load to Driver</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                {/* Load Info */}
                <div style={{
                  background: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                  border: '2px solid var(--primary)',
                  borderRadius: '8px',
                  padding: '1rem',
                  marginBottom: '1.5rem'
                }}>
                  <h4 style={{color: 'var(--primary)', marginBottom: '0.5rem', fontWeight: 700}}>
                    Load: {load.loadNumber}
                  </h4>
                  <div style={{fontSize: '0.95rem', lineHeight: 1.6}}>
                    <div><strong>Route:</strong> {load.pickupLocation} ‚Üí {load.deliveryLocation}</div>
                    <div><strong>Distance:</strong> {load.distance} miles</div>
                    <div><strong>Pay:</strong> <span style={{color: 'var(--success)', fontWeight: 700}}>${load.estimatedPay}</span></div>
                    <div><strong>Status:</strong> <span className={`badge badge-${load.status.toLowerCase()}`}>{load.status}</span></div>
                  </div>
                </div>
                
                {/* Search Drivers */}
                <div className="form-group">
                  <label className="form-label">üîç Search Drivers</label>
                  <input
                    type="text"
                    className="form-input"
                    placeholder="Search by name, truck number, or email..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
                
                {/* Driver Selection */}
                <div className="form-group">
                  <label className="form-label">Select Driver ({availableDrivers.length} available)</label>
                  <div style={{
                    maxHeight: '300px',
                    overflowY: 'auto',
                    border: '2px solid var(--border)',
                    borderRadius: '8px',
                    padding: '0.5rem'
                  }}>
                    {availableDrivers.length === 0 ? (
                      <div style={{padding: '2rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                        No active drivers found
                      </div>
                    ) : (
                      availableDrivers.map(driver => (
                        <div
                          key={driver.id}
                          onClick={() => setSelectedDriverId(driver.id)}
                          style={{
                            padding: '1rem',
                            margin: '0.5rem 0',
                            border: `2px solid ${selectedDriverId === driver.id ? 'var(--primary)' : 'var(--border)'}`,
                            background: selectedDriverId === driver.id ? '#dbeafe' : 'white',
                            borderRadius: '8px',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                          }}
                        >
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
                            <div style={{flex: 1}}>
                              <div style={{fontWeight: 700, fontSize: '1.1rem', marginBottom: '0.25rem'}}>
                                {driver.name}
                                {selectedDriverId === driver.id && (
                                  <span style={{marginLeft: '0.5rem', color: 'var(--primary)'}}>‚úì</span>
                                )}
                              </div>
                              <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', lineHeight: 1.5}}>
                                <div>üöõ Truck: {driver.truckNumber}</div>
                                <div>üìß {driver.email}</div>
                                <div>
                                  {driver.currentStatus === 'DRIVING' && <span style={{color: 'var(--primary)'}}>üöõ Currently Driving</span>}
                                  {driver.currentStatus === 'ON_BREAK' && <span style={{color: 'var(--warning)'}}>‚òï On Break</span>}
                                  {driver.currentStatus === 'SLEEPING' && <span style={{color: 'var(--success)'}}>üò¥ Sleeping</span>}
                                  {(!driver.currentStatus || driver.currentStatus === 'OFF_DUTY') && <span style={{color: 'var(--text-muted)'}}>üè† Off Duty</span>}
                                </div>
                              </div>
                            </div>
                            {driver.locationSharing && (
                              <div style={{
                                background: 'var(--success)',
                                color: 'white',
                                padding: '0.25rem 0.75rem',
                                borderRadius: '12px',
                                fontSize: '0.75rem',
                                fontWeight: 600
                              }}>
                                üìç GPS ON
                              </div>
                            )}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
                
                {selectedDriverId && (
                  <div className="alert alert-success" style={{marginTop: '1rem'}}>
                    <span>‚úÖ</span>
                    <div>
                      <strong>Ready to assign</strong>
                      <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                        {availableDrivers.find(d => d.id === selectedDriverId)?.name} will be notified immediately
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="modal-footer">
                <button type="button" className="btn btn-outline" onClick={onClose}>Cancel</button>
                <button 
                  type="submit" 
                  className="btn btn-primary" 
                  disabled={!selectedDriverId}
                >
                  {currentDriverId ? 'üîÑ Reassign Load' : '‚úÖ Assign Load'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function UploadDocumentModal({ loads, onClose, onUpload }) {
      const [selectedLoad, setSelectedLoad] = useState('');
      const [docType, setDocType] = useState('POD');
      const [file, setFile] = useState(null);
      const [fileData, setFileData] = useState(null);
      const [validation, setValidation] = useState(null);

      const handleFileChange = (e) => {
        const f = e.target.files[0];
        if (f) {
          setFile(f);
          
          // Read file as base64
          const reader = new FileReader();
          reader.onload = (event) => {
            setFileData(event.target.result);
          };
          reader.readAsDataURL(f);
          
          const result = TruckMateAI.validateDocument(f, docType);
          setValidation(result);
        }
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (validation?.isValid && fileData) {
          // Store document info
          const docInfo = {
            loadId: selectedLoad,
            docType: docType,
            fileName: file.name,
            fileSize: file.size,
            fileData: fileData, // base64 data
            uploadedAt: new Date().toISOString(),
            validation: validation
          };
          
          // Save to localStorage for this load
          const storedDocs = JSON.parse(localStorage.getItem('truckmate_documents') || '{}');
          if (!storedDocs[selectedLoad]) {
            storedDocs[selectedLoad] = [];
          }
          storedDocs[selectedLoad].push(docInfo);
          localStorage.setItem('truckmate_documents', JSON.stringify(storedDocs));
          
          onUpload(docInfo);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Upload Document</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">Select Load</label>
                  <select className="form-select" required value={selectedLoad} onChange={e => setSelectedLoad(e.target.value)}>
                    <option value="">Choose load...</option>
                    {loads.map(load => (
                      <option key={load.id} value={load.id}>
                        {load.loadNumber} - {load.pickupLocation} ‚Üí {load.deliveryLocation}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label className="form-label">Document Type</label>
                  <select className="form-select" value={docType} onChange={e => setDocType(e.target.value)}>
                    <option value="POD">Proof of Delivery (POD)</option>
                    <option value="BOL">Bill of Lading (BOL)</option>
                    <option value="FUEL_RECEIPT">Fuel Receipt</option>
                    <option value="WEIGHT_TICKET">Weight Ticket</option>
                  </select>
                </div>

                <div className="form-group">
                  <label className="form-label">Upload File</label>
                  <div className="file-upload" onClick={() => document.getElementById('file-input').click()}>
                    {file ? (
                      <div>
                        <div style={{fontSize: '2rem'}}>üìÑ</div>
                        <div style={{fontWeight: 600}}>{file.name}</div>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                          {(file.size / 1024).toFixed(1)} KB
                        </div>
                      </div>
                    ) : (
                      <div>
                        <div style={{fontSize: '2rem'}}>üì§</div>
                        <div>Click to upload</div>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginTop: '0.5rem'}}>
                          Supports: Images, PDFs
                        </div>
                      </div>
                    )}
                  </div>
                  <input
                    id="file-input"
                    type="file"
                    accept="image/*,.pdf"
                    onChange={handleFileChange}
                    style={{display: 'none'}}
                  />
                </div>

                {validation && (
                  <div className={`alert ${validation.isValid ? 'alert-success' : 'alert-danger'}`}>
                    <span>{validation.isValid ? '‚úÖ' : 'üö®'}</span>
                    <div>
                      <strong>AI Validation: {validation.confidence}% Confidence</strong>
                      {validation.issues.length > 0 && (
                        <div style={{fontSize: '0.875rem', marginTop: '0.5rem'}}>
                          {validation.issues.map((issue, i) => (
                            <div key={i}>‚Ä¢ {issue.message}</div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              <div className="modal-footer">
                <button type="button" className="btn btn-outline" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-success" disabled={!validation?.isValid}>
                  Upload Document
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    
    function AdminProfileView({ lang, onToggleDriverEdits }) {
      const [allowEdits, setAllowEdits] = useState(true);

      return (
        <div>
          <div className="page-title">{tr(lang,'profile')}</div>
          <div className="card">
            <div className="card-header">
              <div className="card-title">Company Settings</div>
            </div>
            <div className="card-content">
              <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', gap:'1rem', flexWrap:'wrap'}}>
                <div>
                  <div style={{fontWeight:800}}>Allow driver profile edits</div>
                  <div style={{color:'var(--text-muted)', marginTop:'0.25rem'}}>
                    Default: ON for photo & emergency contacts, OFF for CDL/license fields in the full app.
                  </div>
                </div>
                <button
                  className={'btn ' + (allowEdits ? 'btn-success' : 'btn-outline')}
                  style={{minHeight:52}}
                  onClick={() => {
                    const next = !allowEdits;
                    setAllowEdits(next);
                    onToggleDriverEdits?.(next);
                  }}
                >
                  {allowEdits ? 'ON' : 'OFF'}
                </button>
              </div>

              <div style={{marginTop:'1.25rem', padding:'1rem', border:'1px solid var(--border)', borderRadius:12, background:'var(--bg)'}}>
                <div style={{fontWeight:800, marginBottom:'0.5rem'}}>Security Notes</div>
                <ul style={{margin:0, paddingLeft:'1.25rem', color:'var(--text-muted)'}}>
                  <li>Drivers cannot self-signup.</li>
                  <li>Admins create drivers and issue temporary passwords.</li>
                  <li>Location sharing is consent-based.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    }

function DriversView({ drivers, onAddDriver, onViewDriver }) {
      const [search, setSearch] = useState('');
      
      const filtered = drivers.filter(d => 
        d.name.toLowerCase().includes(search.toLowerCase()) ||
        d.email.toLowerCase().includes(search.toLowerCase()) ||
        d.truckNumber.toLowerCase().includes(search.toLowerCase())
      );

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
            <h1 style={{fontSize: '2rem', fontWeight: 900}}>Drivers ({drivers.length})</h1>
            <button className="btn btn-primary" onClick={onAddDriver}>
              ‚ûï Create Driver Account
            </button>
          </div>

          <div className="card">
            <div style={{marginBottom: '1.5rem'}}>
              <input
                className="form-input"
                placeholder="Search drivers by name, email, or truck number..."
                value={search}
                onChange={e => setSearch(e.target.value)}
              />
            </div>

            <table className="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Truck #</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Current Activity</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filtered.slice(0, 50).map(driver => (
                  <tr key={driver.id}>
                    <td><strong>{driver.name}</strong></td>
                    <td>{driver.email}</td>
                    <td>{driver.truckNumber}</td>
                    <td>{driver.phone}</td>
                    <td>
                      <span className={`badge badge-${driver.status.toLowerCase()}`}>
                        {driver.status}
                      </span>
                    </td>
                    <td>
                      {driver.currentStatus === 'DRIVING' && <span style={{color: 'var(--primary)', fontWeight: 600}}>üöõ Driving</span>}
                      {driver.currentStatus === 'ON_BREAK' && <span style={{color: 'var(--warning)', fontWeight: 600}}>‚òï On Break</span>}
                      {driver.currentStatus === 'SLEEPING' && <span style={{color: 'var(--success)', fontWeight: 600}}>üò¥ Sleeping</span>}
                      {(!driver.currentStatus || driver.currentStatus === 'OFF_DUTY') && <span style={{color: 'var(--text-muted)'}}>üè† Off Duty</span>}
                    </td>
                    <td>
                      {driver.locationSharing ? (
                        <span style={{color: 'var(--success)', fontWeight: 600}}>üìç Sharing</span>
                      ) : (
                        <span style={{color: 'var(--text-muted)'}}>‚ö™ Off</span>
                      )}
                    </td>
                    <td>
                      <button 
                        className="btn btn-outline" 
                        onClick={() => onViewDriver(driver)}
                        style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                      >
                        View
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function CreateDriverModal({ onClose, onCreate }) {
      const [formData, setFormData] = useState({
        name: '',
        email: '',
        phone: '',
        truckNumber: '',
        tempPassword: Math.random().toString(36).slice(-8),
        status: 'ACTIVE'
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onCreate(formData);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Create Driver Account</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="alert alert-info">
                  <span>‚ÑπÔ∏è</span>
                  <div>
                    <strong>Creating driver account</strong>
                    <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                      A temporary password will be generated. Share the login credentials with the driver after creation.
                    </div>
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Full Name *</label>
                  <input
                    className="form-input"
                    required
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                    placeholder="John Smith"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Email *</label>
                  <input
                    type="email"
                    className="form-input"
                    required
                    value={formData.email}
                    onChange={e => setFormData({...formData, email: e.target.value})}
                    placeholder="driver@example.com"
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Phone *</label>
                    <input
                      type="tel"
                      className="form-input"
                      required
                      value={formData.phone}
                      onChange={e => setFormData({...formData, phone: e.target.value})}
                      placeholder="+1 (555) 123-4567"
                    />
                  </div>

                  <div className="form-group">
                    <label className="form-label">Truck Number *</label>
                    <input
                      className="form-input"
                      required
                      value={formData.truckNumber}
                      onChange={e => setFormData({...formData, truckNumber: e.target.value})}
                      placeholder="TRK-001"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Temporary Password</label>
                  <input
                    className="form-input"
                    readOnly
                    value={formData.tempPassword}
                    style={{background: 'var(--bg)', cursor: 'not-allowed'}}
                  />
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)', marginTop: '0.5rem'}}>
                    Auto-generated. Share this with the driver after account creation.
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">Initial Status</label>
                  <select 
                    className="form-select"
                    value={formData.status}
                    onChange={e => setFormData({...formData, status: e.target.value})}
                  >
                    <option value="ACTIVE">Active</option>
                    <option value="OFF_DUTY">Off Duty</option>
                  </select>
                </div>
              </div>

              <div className="modal-footer">
                <button type="button" className="btn btn-outline" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary">
                  Create Driver Account
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function TasksView({ tasks, drivers, onCreateTask, onViewTask }) {
      const [filter, setFilter] = useState('ALL');
      
      const filtered = tasks.filter(t => {
        if (filter === 'ALL') return true;
        return t.status === filter;
      });

      const statusCounts = {
        PENDING: tasks.filter(t => t.status === 'PENDING').length,
        IN_PROGRESS: tasks.filter(t => t.status === 'IN_PROGRESS').length,
        COMPLETED: tasks.filter(t => t.status === 'COMPLETED').length
      };

      return (
        <div>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
            <h1 style={{fontSize: '2rem', fontWeight: 900}}>Tasks & Assignments</h1>
            <button className="btn btn-primary" onClick={onCreateTask}>
              ‚ûï Assign New Task
            </button>
          </div>

          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-value">{tasks.length}</div>
              <div className="stat-label">Total Tasks</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--warning)'}}>{statusCounts.PENDING}</div>
              <div className="stat-label">Pending</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--primary)'}}>{statusCounts.IN_PROGRESS}</div>
              <div className="stat-label">In Progress</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--success)'}}>{statusCounts.COMPLETED}</div>
              <div className="stat-label">Completed</div>
            </div>
          </div>

          <div className="card">
            <div style={{marginBottom: '1.5rem', display: 'flex', gap: '0.5rem'}}>
              <button 
                className={`btn ${filter === 'ALL' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => setFilter('ALL')}
                style={{padding: '0.5rem 1rem'}}
              >
                All ({tasks.length})
              </button>
              <button 
                className={`btn ${filter === 'PENDING' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => setFilter('PENDING')}
                style={{padding: '0.5rem 1rem'}}
              >
                Pending ({statusCounts.PENDING})
              </button>
              <button 
                className={`btn ${filter === 'IN_PROGRESS' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => setFilter('IN_PROGRESS')}
                style={{padding: '0.5rem 1rem'}}
              >
                In Progress ({statusCounts.IN_PROGRESS})
              </button>
              <button 
                className={`btn ${filter === 'COMPLETED' ? 'btn-primary' : 'btn-outline'}`}
                onClick={() => setFilter('COMPLETED')}
                style={{padding: '0.5rem 1rem'}}
              >
                Completed ({statusCounts.COMPLETED})
              </button>
            </div>

            {filtered.length === 0 ? (
              <div style={{textAlign: 'center', padding: '3rem', color: 'var(--text-muted)'}}>
                <div style={{fontSize: '3rem', marginBottom: '1rem'}}>‚úì</div>
                <h3 style={{marginBottom: '0.5rem'}}>No Tasks Yet</h3>
                <p>Click "Assign New Task" to create your first task</p>
              </div>
            ) : (
              <table className="table">
                <thead>
                  <tr>
                    <th>Task</th>
                    <th>Driver</th>
                    <th>Priority</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map(task => (
                    <tr key={task.id}>
                      <td>
                        <strong>{task.title}</strong>
                        <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                          {task.description?.substring(0, 50)}...
                        </div>
                      </td>
                      <td>{drivers.find(d => d.id === task.driverId)?.name}</td>
                      <td>
                        <span className={`badge badge-${task.priority === 'HIGH' ? 'danger' : task.priority === 'MEDIUM' ? 'pending' : 'active'}`}>
                          {task.priority}
                        </span>
                      </td>
                      <td>{task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No deadline'}</td>
                      <td>
                        <span className={`badge badge-${task.status === 'COMPLETED' ? 'approved' : task.status === 'IN_PROGRESS' ? 'assigned' : 'pending'}`}>
                          {task.status.replace('_', ' ')}
                        </span>
                      </td>
                      <td>
                        <button 
                          className="btn btn-outline" 
                          onClick={() => onViewTask(task)}
                          style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                        >
                          View
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    }

    function DriverTasksView({ tasks, onUpdateStatus }) {
      const pendingTasks = tasks.filter(t => t.status === 'PENDING');
      const inProgressTasks = tasks.filter(t => t.status === 'IN_PROGRESS');
      const completedTasks = tasks.filter(t => t.status === 'COMPLETED');

      const TaskCard = ({ task }) => (
        <div className="card" style={{marginBottom: '1rem'}}>
          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
            <div style={{flex: 1}}>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>
                {task.title}
              </h3>
              <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
                {task.description}
              </p>
              <div style={{display: 'flex', gap: '1rem', fontSize: '0.875rem'}}>
                <div>
                  <strong>Priority:</strong>{' '}
                  <span className={`badge badge-${task.priority === 'HIGH' ? 'danger' : task.priority === 'MEDIUM' ? 'pending' : 'active'}`}>
                    {task.priority}
                  </span>
                </div>
                {task.dueDate && (
                  <div>
                    <strong>Due:</strong> {new Date(task.dueDate).toLocaleDateString()}
                  </div>
                )}
                {task.loadId && (
                  <div>
                    <strong>Load:</strong> {task.loadId}
                  </div>
                )}
              </div>
            </div>
            <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
              {task.status === 'PENDING' && (
                <button 
                  className="btn btn-primary"
                  onClick={() => onUpdateStatus(task.id, 'IN_PROGRESS')}
                  style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                >
                  Start Task
                </button>
              )}
              {task.status === 'IN_PROGRESS' && (
                <button 
                  className="btn btn-success"
                  onClick={() => onUpdateStatus(task.id, 'COMPLETED')}
                  style={{padding: '0.5rem 1rem', fontSize: '0.875rem'}}
                >
                  Mark Complete
                </button>
              )}
            </div>
          </div>
        </div>
      );

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>My Tasks</h1>

          <div className="stats-grid">
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--warning)'}}>{pendingTasks.length}</div>
              <div className="stat-label">Pending</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--primary)'}}>{inProgressTasks.length}</div>
              <div className="stat-label">In Progress</div>
            </div>
            <div className="stat-card">
              <div className="stat-value" style={{color: 'var(--success)'}}>{completedTasks.length}</div>
              <div className="stat-label">Completed</div>
            </div>
            <div className="stat-card">
              <div className="stat-value">{tasks.length}</div>
              <div className="stat-label">Total Tasks</div>
            </div>
          </div>

          {tasks.length === 0 ? (
            <div className="card" style={{textAlign: 'center', padding: '3rem'}}>
              <div style={{fontSize: '3rem', marginBottom: '1rem'}}>‚úì</div>
              <h3 style={{marginBottom: '0.5rem'}}>No Tasks Assigned</h3>
              <p style={{color: 'var(--text-muted)'}}>Your admin will assign tasks to you</p>
            </div>
          ) : (
            <>
              {pendingTasks.length > 0 && (
                <>
                  <h2 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem'}}>
                    ‚è≥ Pending Tasks
                  </h2>
                  {pendingTasks.map(task => <TaskCard key={task.id} task={task} />)}
                </>
              )}

              {inProgressTasks.length > 0 && (
                <>
                  <h2 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem', marginTop: '2rem'}}>
                    üîÑ In Progress
                  </h2>
                  {inProgressTasks.map(task => <TaskCard key={task.id} task={task} />)}
                </>
              )}

              {completedTasks.length > 0 && (
                <>
                  <h2 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem', marginTop: '2rem'}}>
                    ‚úÖ Completed
                  </h2>
                  {completedTasks.map(task => <TaskCard key={task.id} task={task} />)}
                </>
              )}
            </>
          )}
        </div>
      );
    }

    function DriverScheduleView({ schedule, driver }) {
      const today = new Date();
      const upcoming = schedule.filter(s => new Date(s.date) >= today).sort((a, b) => new Date(a.date) - new Date(b.date));
      const past = schedule.filter(s => new Date(s.date) < today).sort((a, b) => new Date(b.date) - new Date(a.date));

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>My Schedule</h1>

          <div className="alert alert-info">
            <span>üìÖ</span>
            <div>
              <strong>Your Upcoming Schedule</strong>
              <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                All scheduled loads, tasks, and appointments appear here
              </div>
            </div>
          </div>

          {upcoming.length === 0 && past.length === 0 ? (
            <div className="card" style={{textAlign: 'center', padding: '3rem'}}>
              <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üìÖ</div>
              <h3 style={{marginBottom: '0.5rem'}}>No Schedule Yet</h3>
              <p style={{color: 'var(--text-muted)'}}>Your admin will schedule loads and tasks for you</p>
            </div>
          ) : (
            <>
              {upcoming.length > 0 && (
                <>
                  <h2 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem'}}>
                    üìç Upcoming ({upcoming.length})
                  </h2>
                  <div className="card">
                    <table className="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Time</th>
                          <th>Type</th>
                          <th>Details</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {upcoming.map((item, i) => (
                          <tr key={i}>
                            <td><strong>{new Date(item.date).toLocaleDateString()}</strong></td>
                            <td>{item.time || 'All day'}</td>
                            <td><span className="badge badge-assigned">{item.type}</span></td>
                            <td>{item.details}</td>
                            <td><span className="badge badge-pending">Scheduled</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}

              {past.length > 0 && (
                <>
                  <h2 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem', marginTop: '2rem'}}>
                    ‚úÖ Past Events ({past.length})
                  </h2>
                  <div className="card">
                    <table className="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Type</th>
                          <th>Details</th>
                        </tr>
                      </thead>
                      <tbody>
                        {past.slice(0, 10).map((item, i) => (
                          <tr key={i}>
                            <td>{new Date(item.date).toLocaleDateString()}</td>
                            <td><span className="badge badge-active">{item.type}</span></td>
                            <td>{item.details}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}
            </>
          )}
        </div>
      );
    }

    function NearbyPlacesView({ driver }) {
      const [searchType, setSearchType] = useState('fuel');
      const [searching, setSearching] = useState(false);

      const handleSearch = (type) => {
        setSearchType(type);
        setSearching(true);
        
        setTimeout(() => {
          setSearching(false);
          const query = type === 'fuel' ? 'truck stop near me' : 'fast food near me';
          window.open(`https://www.google.com/maps/search/${encodeURIComponent(query)}`, '_blank');
        }, 500);
      };

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>Find Nearby Places</h1>

          <div className="alert alert-info">
            <span>üìç</span>
            <div>
              <strong>Location-Based Search</strong>
              <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                Find fuel stops, restaurants, rest areas, and services near your current location
              </div>
            </div>
          </div>

          <div className="stats-grid">
            <div className="card" style={{textAlign: 'center', cursor: 'pointer'}} onClick={() => handleSearch('fuel')}>
              <div style={{fontSize: '4rem', marginBottom: '1rem'}}>‚õΩ</div>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>Fuel Stops</h3>
              <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
                Gas stations, truck stops, diesel
              </p>
              <button className="btn btn-primary" style={{width: '100%'}}>
                Find Fuel
              </button>
            </div>

            <div className="card" style={{textAlign: 'center', cursor: 'pointer'}} onClick={() => handleSearch('food')}>
              <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üçî</div>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>Food & Restaurants</h3>
              <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
                Fast food, diners, restaurants
              </p>
              <button className="btn btn-primary" style={{width: '100%'}}>
                Find Food
              </button>
            </div>

            <div className="card" style={{textAlign: 'center', cursor: 'pointer'}} onClick={() => window.open('https://www.google.com/maps/search/rest+area+near+me', '_blank')}>
              <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üõèÔ∏è</div>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>Rest Areas</h3>
              <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
                Rest stops, truck parking
              </p>
              <button className="btn btn-primary" style={{width: '100%'}}>
                Find Rest Area
              </button>
            </div>

            <div className="card" style={{textAlign: 'center', cursor: 'pointer'}} onClick={() => window.open('https://www.google.com/maps/search/truck+service+near+me', '_blank')}>
              <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üîß</div>
              <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem'}}>Service Centers</h3>
              <p style={{color: 'var(--text-muted)', marginBottom: '1rem'}}>
                Truck repair, maintenance
              </p>
              <button className="btn btn-primary" style={{width: '100%'}}>
                Find Service
              </button>
            </div>
          </div>

          <div className="card">
            <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginBottom: '1rem'}}>üö® Emergency Contacts</h3>
            <div style={{display: 'grid', gap: '1rem'}}>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: 'var(--bg)', borderRadius: '8px'}}>
                <div>
                  <div style={{fontWeight: 700}}>Emergency Services</div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Police, Fire, Ambulance</div>
                </div>
                <a href="tel:911" className="btn btn-danger">Call 911</a>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: 'var(--bg)', borderRadius: '8px'}}>
                <div>
                  <div style={{fontWeight: 700}}>Roadside Assistance</div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Towing, tire service, fuel delivery</div>
                </div>
                <a href="tel:1-800-AAA-HELP" className="btn btn-primary">Call AAA</a>
              </div>
              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '1rem', background: 'var(--bg)', borderRadius: '8px'}}>
                <div>
                  <div style={{fontWeight: 700}}>Dispatch</div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>Your company dispatch</div>
                </div>
                <a href="tel:1-555-DISPATCH" className="btn btn-primary">Call Dispatch</a>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DriverProfileView({ driver, onUpdate }) {
      const [editing, setEditing] = useState(false);
      const [formData, setFormData] = useState({
        phone: driver.phone,
        emergencyContact: driver.emergencyContact?.name || '',
        emergencyPhone: driver.emergencyContact?.phone || '',
        profilePicture: driver.profilePicture || null
      });

      const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setFormData({...formData, profilePicture: reader.result});
          };
          reader.readAsDataURL(file);
        }
      };

      const handleSave = () => {
        onUpdate({
          phone: formData.phone,
          emergencyContact: {
            name: formData.emergencyContact,
            phone: formData.emergencyPhone,
            relationship: 'Emergency Contact'
          },
          profilePicture: formData.profilePicture
        });
        setEditing(false);
      };

      return (
        <div>
          <h1 style={{marginBottom: '2rem', fontSize: '2rem', fontWeight: 900}}>My Profile</h1>

          <div className="card">
            <div style={{display: 'flex', gap: '2rem', alignItems: 'start'}}>
              {/* Profile Picture */}
              <div style={{textAlign: 'center'}}>
                <div style={{
                  width: 150,
                  height: 150,
                  borderRadius: '50%',
                  background: formData.profilePicture ? `url(${formData.profilePicture}) center/cover` : 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: '3rem',
                  color: 'white',
                  fontWeight: 900,
                  marginBottom: '1rem',
                  border: '4px solid white',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                }}>
                  {!formData.profilePicture && driver.name[0]}
                </div>
                {editing && (
                  <>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleImageUpload}
                      style={{display: 'none'}}
                      id="profile-pic-upload"
                    />
                    <label htmlFor="profile-pic-upload" className="btn btn-outline" style={{cursor: 'pointer'}}>
                      Change Photo
                    </label>
                  </>
                )}
              </div>

              {/* Profile Info */}
              <div style={{flex: 1}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem'}}>
                  <div>
                    <h2 style={{fontSize: '1.75rem', fontWeight: 900, marginBottom: '0.25rem'}}>{driver.name}</h2>
                    <div style={{color: 'var(--text-muted)'}}>{driver.email}</div>
                  </div>
                  {!editing ? (
                    <button className="btn btn-primary" onClick={() => setEditing(true)}>
                      Edit Profile
                    </button>
                  ) : (
                    <div style={{display: 'flex', gap: '0.5rem'}}>
                      <button className="btn btn-outline" onClick={() => setEditing(false)}>Cancel</button>
                      <button className="btn btn-success" onClick={handleSave}>Save Changes</button>
                    </div>
                  )}
                </div>

                <div className="stats-grid" style={{marginBottom: '2rem'}}>
                  <div>
                    <div className="stat-label">Truck Number</div>
                    <div style={{fontWeight: 700, fontSize: '1.25rem', marginTop: '0.5rem'}}>{driver.truckNumber}</div>
                  </div>
                  <div>
                    <div className="stat-label">CDL Class</div>
                    <div style={{fontWeight: 700, fontSize: '1.25rem', marginTop: '0.5rem'}}>{driver.cdlClass || 'Class A'}</div>
                  </div>
                  <div>
                    <div className="stat-label">Status</div>
                    <div style={{marginTop: '0.5rem'}}>
                      <span className={`badge badge-${driver.status.toLowerCase()}`}>{driver.status}</span>
                    </div>
                  </div>
                  <div>
                    <div className="stat-label">Total Miles</div>
                    <div style={{fontWeight: 700, fontSize: '1.25rem', marginTop: '0.5rem'}}>
                      {(driver.totalMiles || 50000).toLocaleString()}
                    </div>
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Phone Number</label>
                    <input
                      className="form-input"
                      value={formData.phone}
                      onChange={e => setFormData({...formData, phone: e.target.value})}
                      disabled={!editing}
                      style={{background: editing ? 'white' : 'var(--bg)'}}
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">License Number</label>
                    <input
                      className="form-input"
                      value={driver.licenseNumber}
                      disabled
                      style={{background: 'var(--bg)', cursor: 'not-allowed'}}
                    />
                  </div>
                </div>

                <h3 style={{fontSize: '1.25rem', fontWeight: 700, marginTop: '2rem', marginBottom: '1rem'}}>
                  Emergency Contact
                </h3>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Contact Name</label>
                    <input
                      className="form-input"
                      value={formData.emergencyContact}
                      onChange={e => setFormData({...formData, emergencyContact: e.target.value})}
                      disabled={!editing}
                      style={{background: editing ? 'white' : 'var(--bg)'}}
                      placeholder="Emergency contact name"
                    />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Contact Phone</label>
                    <input
                      className="form-input"
                      value={formData.emergencyPhone}
                      onChange={e => setFormData({...formData, emergencyPhone: e.target.value})}
                      disabled={!editing}
                      style={{background: editing ? 'white' : 'var(--bg)'}}
                      placeholder="Emergency contact phone"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function CreateTaskModal({ drivers, loads, onClose, onCreate }) {
      const [formData, setFormData] = useState({
        driverId: '',
        title: '',
        description: '',
        priority: 'MEDIUM',
        dueDate: '',
        loadId: '',
        type: 'GENERAL'
      });

      const handleSubmit = (e) => {
        e.preventDefault();
        onCreate(formData);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Assign New Task</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">Assign To Driver *</label>
                  <select 
                    className="form-select" 
                    required 
                    value={formData.driverId}
                    onChange={e => setFormData({...formData, driverId: e.target.value})}
                  >
                    <option value="">Select driver...</option>
                    {drivers.filter(d => d.status === 'ACTIVE').slice(0, 50).map(driver => (
                      <option key={driver.id} value={driver.id}>
                        {driver.name} - {driver.truckNumber}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-group">
                  <label className="form-label">Task Type</label>
                  <select 
                    className="form-select"
                    value={formData.type}
                    onChange={e => setFormData({...formData, type: e.target.value})}
                  >
                    <option value="GENERAL">General Task</option>
                    <option value="LOAD_RELATED">Load Related</option>
                    <option value="MAINTENANCE">Maintenance</option>
                    <option value="INSPECTION">Inspection</option>
                    <option value="DOCUMENTATION">Documentation</option>
                  </select>
                </div>

                {formData.type === 'LOAD_RELATED' && (
                  <div className="form-group">
                    <label className="form-label">Related Load</label>
                    <select 
                      className="form-select"
                      value={formData.loadId}
                      onChange={e => setFormData({...formData, loadId: e.target.value})}
                    >
                      <option value="">Select load (optional)...</option>
                      {loads.map(load => (
                        <option key={load.id} value={load.loadNumber}>
                          {load.loadNumber} - {load.pickupLocation} ‚Üí {load.deliveryLocation}
                        </option>
                      ))}
                    </select>
                  </div>
                )}

                <div className="form-group">
                  <label className="form-label">Task Title *</label>
                  <input
                    className="form-input"
                    required
                    value={formData.title}
                    onChange={e => setFormData({...formData, title: e.target.value})}
                    placeholder="e.g., Inspect trailer before loading"
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">Description *</label>
                  <textarea
                    className="form-input"
                    required
                    value={formData.description}
                    onChange={e => setFormData({...formData, description: e.target.value})}
                    placeholder="Provide detailed instructions for the driver..."
                    rows="4"
                    style={{resize: 'vertical'}}
                  />
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Priority</label>
                    <select 
                      className="form-select"
                      value={formData.priority}
                      onChange={e => setFormData({...formData, priority: e.target.value})}
                    >
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label className="form-label">Due Date</label>
                    <input
                      type="date"
                      className="form-input"
                      value={formData.dueDate}
                      onChange={e => setFormData({...formData, dueDate: e.target.value})}
                    />
                  </div>
                </div>

                <div className="alert alert-info">
                  <span>‚ÑπÔ∏è</span>
                  <div>
                    <strong>Task Notification</strong>
                    <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                      Driver will be notified immediately and can view task in "My Tasks" section.
                    </div>
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button type="button" className="btn btn-outline" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary">
                  Assign Task
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function ViewTaskModal({ task, driver, onClose }) {
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Task Details</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="modal-body">
              <div style={{marginBottom: '1.5rem'}}>
                <h4 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem'}}>
                  {task.title}
                </h4>
                <div style={{display: 'flex', gap: '1rem', marginTop: '0.5rem'}}>
                  <span className={`badge badge-${task.status === 'COMPLETED' ? 'approved' : task.status === 'IN_PROGRESS' ? 'assigned' : 'pending'}`}>
                    {task.status.replace('_', ' ')}
                  </span>
                  <span className={`badge badge-${task.priority === 'HIGH' ? 'danger' : task.priority === 'MEDIUM' ? 'pending' : 'active'}`}>
                    {task.priority} PRIORITY
                  </span>
                </div>
              </div>

              <div style={{marginBottom: '1.5rem'}}>
                <strong style={{display: 'block', marginBottom: '0.5rem'}}>Description:</strong>
                <p style={{color: 'var(--text-muted)'}}>{task.description}</p>
              </div>

              <div className="stats-grid">
                <div>
                  <div className="stat-label">Assigned To</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>
                    {driver?.name}
                  </div>
                  <div style={{fontSize: '0.875rem', color: 'var(--text-muted)'}}>
                    {driver?.truckNumber}
                  </div>
                </div>
                <div>
                  <div className="stat-label">Task Type</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>
                    {task.type?.replace('_', ' ')}
                  </div>
                </div>
                <div>
                  <div className="stat-label">Created</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>
                    {new Date(task.createdAt).toLocaleDateString()}
                  </div>
                </div>
                <div>
                  <div className="stat-label">Due Date</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>
                    {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No deadline'}
                  </div>
                </div>
              </div>

              {task.loadId && (
                <div style={{marginTop: '1.5rem'}}>
                  <div className="alert alert-info">
                    <span>üì¶</span>
                    <div>
                      <strong>Related Load:</strong> {task.loadId}
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="modal-footer">
              <button className="btn btn-outline" onClick={onClose}>Close</button>
              <button className="btn btn-primary">Send Message to Driver</button>
            </div>
          </div>
        </div>
      );
    }

    function ViewDriverModal({ driver, onClose }) {
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">Driver Details</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="modal-body">
              <div style={{marginBottom: '2rem'}}>
                <h4 style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem'}}>
                  {driver.name}
                </h4>
                <div style={{color: 'var(--text-muted)'}}>{driver.email}</div>
              </div>

              <div className="stats-grid">
                <div>
                  <div className="stat-label">Phone</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>{driver.phone}</div>
                </div>
                <div>
                  <div className="stat-label">Truck Number</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>{driver.truckNumber}</div>
                </div>
                <div>
                  <div className="stat-label">Status</div>
                  <div style={{marginTop: '0.5rem'}}>
                    <span className={`badge badge-${driver.status.toLowerCase()}`}>
                      {driver.status}
                    </span>
                  </div>
                </div>
                <div>
                  <div className="stat-label">Location Sharing</div>
                  <div style={{fontWeight: 600, fontSize: '1rem', marginTop: '0.5rem'}}>
                    {driver.locationSharing ? (
                      <span style={{color: 'var(--success)'}}>üìç ON</span>
                    ) : (
                      <span style={{color: 'var(--text-muted)'}}>‚ö™ OFF</span>
                    )}
                  </div>
                </div>
              </div>

              {driver.lastLocation && driver.locationSharing && (
                <div style={{marginTop: '1.5rem'}}>
                  <div className="alert alert-success">
                    <span>üìç</span>
                    <div>
                      <strong>Last Known Location</strong>
                      <div style={{fontSize: '0.875rem', marginTop: '0.5rem'}}>
                        Lat: {driver.lastLocation.lat.toFixed(6)}, Lng: {driver.lastLocation.lng.toFixed(6)}
                        <br />
                        Last update: {new Date(driver.lastLocation.timestamp).toLocaleString()}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {!driver.locationSharing && (
                <div style={{marginTop: '1.5rem'}}>
                  <div className="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                      <strong>Location Sharing Disabled</strong>
                      <div style={{fontSize: '0.875rem', marginTop: '0.25rem'}}>
                        This driver has location sharing turned off. You can request them to enable it via Inbox.
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="modal-footer">
              <button className="btn btn-outline" onClick={onClose}>Close</button>
              <button className="btn btn-primary">Send Message</button>
            </div>
          </div>
        </div>
      );
    }

    function AIAssistant({ user, driver, loads, locationSharing, drivers, onClose }) {
      const [messages, setMessages] = useState([
        { role: 'assistant', content: 'Hi! I am TruckMate AI. How can I help you today?' }
      ]);
      const [input, setInput] = useState('');
      const [isTyping, setIsTyping] = useState(false);

      const handleSend = () => {
        if (!input.trim()) return;
        
        setMessages([...messages, { role: 'user', content: input }]);
        setInput('');
        setIsTyping(true);

        setTimeout(() => {
          const response = TruckMateAI.generateResponse(input, {
            loads,
            trips: [],
            user,
            locationSharing,
            drivers
          });
          
          setMessages(prev => [...prev, { role: 'assistant', content: response }]);
          setIsTyping(false);
        }, 800);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3 className="modal-title">‚ú® TruckMate AI Assistant</h3>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="modal-body">
              <div className="message-list">
                {messages.map((msg, i) => (
                  <div key={i} className={`message ${msg.role === 'user' ? 'sent' : 'received'}`}>
                    <div className="message-avatar">
                      {msg.role === 'user' ? user.name[0] : '‚ú®'}
                    </div>
                    <div>
                      <div className="message-bubble" style={{whiteSpace: 'pre-wrap'}}>
                        {msg.content}
                      </div>
                    </div>
                  </div>
                ))}
                {isTyping && (
                  <div className="message received">
                    <div className="message-avatar">‚ú®</div>
                    <div className="message-bubble">Typing...</div>
                  </div>
                )}
              </div>

              <div style={{display: 'flex', gap: '0.5rem'}}>
                <input
                  className="form-input"
                  placeholder="Ask me anything..."
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyPress={e => e.key === 'Enter' && handleSend()}
                  style={{flex: 1, marginBottom: 0}}
                />
                <button className="btn btn-primary" onClick={handleSend}>Send</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>

